<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Цифровий архів найдавнішого міста Рівненщини - Дубровиці. Історія від 1005 року, фотоархів, метричні книги">
    <meta name="keywords" content="Дубровиця, історія, архів, Рівненська область, Україна, Полісся">
    <meta property="og:title" content="Дубровиця — Найдавніше місто Рівненщини">
    <meta property="og:description" content="Цифровий архів історичної спадщини міста Дубровиця">
    <meta property="og:type" content="website">
    <title>Дубровиця — Історія та спадщина</title>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;500;600;700&family=DM+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-container">
            <a href="index.html" class="logo">
                <img src="https://i.imgur.com/mXCrjjG.png" alt="Герб" class="logo-img" loading="lazy">
                <div class="logo-text">
                    <span class="logo-city">Дубровиця</span>
                    <span class="logo-subtitle">Цифровий архів</span>
                </div>
            </a>
            
            <nav class="nav" id="mainNav">
                <a href="index.html" class="nav-link active">Головна</a>
                <a href="history.html" class="nav-link">Історія</a>
                <a href="photo-archive.html" class="nav-link">Фотоархів</a>
                <a href="metrychni-knyhy.html" class="nav-link">Метричні книги</a>
                <a href="books.html" class="nav-link">Книги</a>
                <a href="contacts.html" class="nav-link">Контакти</a>
            </nav>

            <button class="theme-toggle" id="themeToggle" aria-label="Перемкнути тему">
                <svg class="theme-icon sun-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="5"></circle>
                    <line x1="12" y1="1" x2="12" y2="3"></line>
                    <line x1="12" y1="21" x2="12" y2="23"></line>
                    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                    <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                    <line x1="1" y1="12" x2="3" y2="12"></line>
                    <line x1="21" y1="12" x2="23" y2="12"></line>
                    <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                    <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                </svg>
                <svg class="theme-icon moon-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                </svg>
            </button>

            <button class="mobile-toggle" id="mobileToggle" aria-label="Відкрити меню">
                <span></span>
                <span></span>
                <span></span>
            </button>
        </div>
    </header>

    <!-- Hero Section with Video Background -->
    <section class="hero">
        <div class="hero-bg">
            <div class="hero-overlay"></div>
        </div>
        <div class="hero-content">
            <div class="hero-text">
                <h1 class="hero-title">
                    Дубровиця
                </h1>
                <p class="hero-subtitle">
                    Найдавніше місто Рівненщини з 1015-річною історією
                </p>
                <div class="hero-meta">
                    <span>Рівненська область</span>
                    <span class="separator">·</span>
                    <span>Полісся</span>
                    <span class="separator">·</span>
                    <span>Україна</span>
                </div>
            </div>
            <div class="hero-scroll fade-in-up delay-3">
                <span class="scroll-text">Прокрутіть</span>
                <div class="scroll-line"></div>
            </div>
        </div>
    </section>

    <!-- Introduction -->
    <section class="intro-section">
        <div class="container">
            <div class="intro-content">
                <p class="intro-lead fade-in-up">
                    Дубровиця — найдавніше місто Рівненської області, перша писемна згадка про яке датується 1005 роком. 
                    Місто розташоване на мальовничих берегах річки Горинь у серці Волинського Полісся.
                </p>
                <p class="intro-text fade-in-up delay-1">
                    Цей цифровий архів створено для збереження, систематизації та популяризації історичної спадщини, 
                    культури та пам'яті нашого міста. Тут ви знайдете історичні фотографії, метричні книги, дослідження 
                    та матеріали, які розкривають багатовікову історію Дубровиці.
                </p>
            </div>
        </div>
    </section>

    <!-- Navigation Cards -->
    <section class="cards-section">
        <div class="container">
            <div class="cards-grid">
                <a href="history.html" class="card fade-in-up">
                    <div class="card-image">
                        <img src="https://i.imgur.com/QTP89kg.jpeg" alt="Історія" loading="lazy">
                    </div>
                    <div class="card-content">
                        <h3 class="card-title">Історія міста</h3>
                        <p class="card-description">
                            Досліджуйте понад тисячолітню історію Дубровиці від першої згадки у 1005 році до сьогодення
                        </p>
                        <span class="card-link">Читати далі →</span>
                    </div>
                </a>

                <a href="photo-archive.html" class="card fade-in-up delay-1">
                    <div class="card-image">
                        <img src="https://i.imgur.com/qcjgN1I.jpeg" alt="Фотоархів" loading="lazy">
                    </div>
                    <div class="card-content">
                        <h3 class="card-title">Фотоархів</h3>
                        <p class="card-description">
                            Унікальна колекція історичних фотографій від кінця XIX століття до наших днів
                        </p>
                        <span class="card-link">Переглянути →</span>
                    </div>
                </a>

                <a href="metrychni-knyhy.html" class="card fade-in-up delay-2">
                    <div class="card-image">
                        <img src="https://i.imgur.com/WeDmtIY.jpeg" alt="Метричні книги" loading="lazy">
                    </div>
                    <div class="card-content">
                        <h3 class="card-title">Метричні книги</h3>
                        <p class="card-description">
                            Генеалогічні дослідження: метричні записи парафій Дубровицького регіону
                        </p>
                        <span class="card-link">Досліджуйте →</span>
                    </div>
                </a>

                <a href="books.html" class="card fade-in-up delay-3">
                    <div class="card-image">
                        <img src="https://i.imgur.com/SPhDh6n.jpeg" alt="Книги" loading="lazy">
                    </div>
                    <div class="card-content">
                        <h3 class="card-title">Книги про Дубровицю</h3>
                        <p class="card-description">
                            Бібліографія досліджень, спогадів та літератури про історію регіону
                        </p>
                        <span class="card-link">Читати →</span>
                    </div>
                </a>
            </div>
        </div>
    </section>

    <!-- Stats Section -->
    <section class="stats-section">
        <div class="container">
            <div class="stats-grid">
                <div class="stat-item fade-in-up">
                    <div class="stat-number" data-target="1015">0</div>
                    <div class="stat-label">Років історії</div>
                </div>
                <div class="stat-item fade-in-up delay-1">
                    <div class="stat-number" data-target="500">0</div>
                    <div class="stat-label">Історичних фотографій</div>
                </div>
                <div class="stat-item fade-in-up delay-2">
                    <div class="stat-number" data-target="20">0</div>
                    <div class="stat-label">Книг та досліджень</div>
                </div>
            </div>
        </div>
    </section>

    <!-- ═══ AERIAL MAPS SECTION ═══ -->
    <section id="AER">
    <style>
    #AER{padding:5rem 0;background:#faf7f2;border-top:1px solid #e8e0d4;}
    [data-theme="dark"] #AER{background:#0e0c0a;border-color:#1e1b18;}
    #AER *{box-sizing:border-box;}
    .AW{max-width:1200px;margin:0 auto;padding:0 2rem;}
    .AH{text-align:center;margin-bottom:3rem;}
    .AT{font-family:'Cormorant Garamond',Georgia,serif;font-size:clamp(1.9rem,3.2vw,2.6rem);font-weight:500;color:#1c1917;margin:0 0 .5rem;}
    [data-theme="dark"] .AT{color:#f0e6c8;}
    .AL{display:block;width:44px;height:2px;background:linear-gradient(90deg,#c9a227,#e0bd5a);margin:.6rem auto 0;border-radius:2px;}
    .AS{font-family:'DM Sans',sans-serif;font-size:.78rem;letter-spacing:.13em;text-transform:uppercase;color:#a09080;margin:.6rem 0 0;}
    .ABLK{margin-bottom:4rem;}
    .ABT{font-family:'Cormorant Garamond',serif;font-size:1.3rem;font-weight:600;color:#1c1917;margin:0 0 1.2rem;display:flex;align-items:center;gap:.8rem;}
    [data-theme="dark"] .ABT{color:#e8d8b8;}
    .ABT::before{content:'';display:inline-block;width:4px;height:22px;background:#c9a227;border-radius:2px;flex-shrink:0;}
    .AG{display:grid;grid-template-columns:1fr 248px;gap:1.5rem;align-items:start;}
    @media(max-width:820px){.AG{grid-template-columns:1fr;}}
    /* Map container: auto height based on image, clips on zoom */
    .MBOX{position:relative;border-radius:12px;overflow:hidden;
          box-shadow:0 4px 12px rgba(0,0,0,.08),0 16px 40px rgba(0,0,0,.13);
          border:1px solid rgba(201,162,39,.12);background:#0a0a0a;
          cursor:grab;touch-action:none;line-height:0;max-height:80vh;}
    .MBOX:active{cursor:grabbing;}
    /* image: natural size with contain, expands box height */
    .MIMG{display:block;width:100%;height:auto;
          filter:sepia(.07) contrast(1.05);
          transform-origin:center center;
          pointer-events:none;user-select:none;}
    /* pin layer: sits on top of image, absolute */
    .MLAY{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;overflow:visible;}
    /* pins */
    .PIN{position:absolute;pointer-events:all;cursor:pointer;
         transform:translate(-50%,-50%);}
    .PRING{position:absolute;top:50%;left:50%;
           width:30px;height:30px;border-radius:50%;
           background:rgba(201,162,39,.28);
           transform:translate(-50%,-50%);
           animation:PR 2.6s ease-out infinite;}
    @keyframes PR{0%{transform:translate(-50%,-50%) scale(1);opacity:.9}
                  65%{transform:translate(-50%,-50%) scale(2.2);opacity:0}
                  100%{transform:translate(-50%,-50%) scale(1);opacity:0}}
    .PDOT{position:relative;z-index:2;width:27px;height:27px;border-radius:50%;
          background:#c9a227;border:2.5px solid rgba(255,255,255,.95);
          box-shadow:0 2px 8px rgba(0,0,0,.6);
          display:flex;align-items:center;justify-content:center;
          font-family:'DM Sans',sans-serif;font-size:9.5px;font-weight:800;color:#1a1000;
          transition:transform .14s,background .14s;}
    .PIN:hover .PDOT,.PIN.act .PDOT{background:#f0c840;transform:scale(1.18);}
    /* tooltip */
    .MTTIP{position:fixed;z-index:9999;
           background:rgba(8,6,4,.94);backdrop-filter:blur(14px);
           border:1px solid rgba(201,162,39,.36);border-radius:10px;
           padding:11px 14px 12px;width:220px;
           pointer-events:auto;
           opacity:0;transform:translateY(5px);
           transition:opacity .18s,transform .18s;
           visibility:hidden;
           box-shadow:0 8px 30px rgba(0,0,0,.55);}
    .MTTIP.show{opacity:1;transform:translateY(0);visibility:visible;}
    .TTX{position:absolute;top:7px;right:8px;width:18px;height:18px;
         border-radius:50%;background:rgba(255,255,255,.09);border:none;
         color:#7a6a5a;cursor:pointer;font-size:.7rem;
         display:flex;align-items:center;justify-content:center;transition:background .14s;}
    .TTX:hover{background:rgba(255,255,255,.22);color:#fff;}
    .TTR{display:flex;align-items:center;gap:7px;margin-bottom:4px;}
    .TTN{flex-shrink:0;width:20px;height:20px;border-radius:50%;background:#c9a227;
         color:#1a1000;font-size:.6rem;font-weight:800;font-family:'DM Sans',sans-serif;
         display:flex;align-items:center;justify-content:center;}
    .TTT{font-family:'Cormorant Garamond',serif;font-size:.92rem;font-weight:600;color:#f0e6c8;line-height:1.2;}
    .TTD{font-family:'DM Sans',sans-serif;font-size:.68rem;color:#9e9080;line-height:1.5;display:block;margin-top:2px;}
    /* zoom btns */
    .ZW{position:absolute;bottom:12px;left:12px;display:flex;flex-direction:column;gap:4px;z-index:10;}
    .ZB{width:32px;height:32px;background:rgba(8,6,4,.82);backdrop-filter:blur(8px);
        border:1px solid rgba(201,162,39,.28);border-radius:7px;color:#c9a227;
        font-size:1.1rem;font-weight:700;cursor:pointer;
        display:flex;align-items:center;justify-content:center;
        font-family:monospace;border:1px solid rgba(201,162,39,.28);
        transition:background .14s;}
    .ZB:hover{background:rgba(201,162,39,.22);color:#f0c840;}
    /* fullscreen btn */
    .FSB{position:absolute;bottom:12px;right:12px;z-index:10;
         width:32px;height:32px;background:rgba(8,6,4,.82);backdrop-filter:blur(8px);
         border:1px solid rgba(201,162,39,.28);border-radius:7px;color:#c9a227;
         font-size:.95rem;cursor:pointer;display:flex;align-items:center;justify-content:center;
         transition:background .14s;}
    .FSB:hover{background:rgba(201,162,39,.22);}
    /* badge */
    .BADGE{position:absolute;top:12px;right:12px;z-index:5;
           background:rgba(8,6,4,.82);backdrop-filter:blur(10px);
           border:1px solid rgba(201,162,39,.28);border-radius:8px;
           padding:5px 11px;pointer-events:none;line-height:1.35;}
    .BADGE .bl{display:block;font-family:'DM Sans',sans-serif;font-size:.5rem;letter-spacing:.16em;text-transform:uppercase;color:#6b5a3e;}
    .BADGE .bd{display:block;font-family:'DM Sans',sans-serif;font-size:.8rem;color:#c9a227;font-weight:600;}
    /* legend */
    .LEG{background:#fff;border:1px solid #e0d8cd;border-radius:12px;
         padding:1.2rem 1rem;position:sticky;top:90px;
         box-shadow:0 2px 4px rgba(0,0,0,.04),0 6px 18px rgba(0,0,0,.06);}
    [data-theme="dark"] .LEG{background:#161310;border-color:#2a2520;}
    .LEGH{font-family:'Cormorant Garamond',serif;font-size:1rem;font-weight:600;
          color:#1c1917;margin:0 0 .75rem;padding-bottom:.6rem;border-bottom:1px solid #e0d8cd;}
    [data-theme="dark"] .LEGH{color:#e0d4bc;border-color:#2a2520;}
    .LEGL{list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:2px;}
    .LEGI{display:flex;align-items:center;gap:8px;padding:5px 7px;border-radius:6px;
          cursor:pointer;border:1px solid transparent;transition:background .13s;
          font-family:'DM Sans',sans-serif;font-size:.72rem;color:#44403c;}
    [data-theme="dark"] .LEGI{color:#a09080;}
    .LEGI:hover{background:#f4efe7;}
    .LEGI.act{background:#fdf5e0;border-color:rgba(201,162,39,.45);}
    .LEGN{flex-shrink:0;width:20px;height:20px;border-radius:50%;background:#c9a227;
          color:#1a1000;font-size:.58rem;font-weight:800;font-family:'DM Sans',sans-serif;
          display:flex;align-items:center;justify-content:center;transition:transform .13s;}
    .LEGI:hover .LEGN,.LEGI.act .LEGN{transform:scale(1.12);}
    .LEGHINT{margin-top:.75rem;font-size:.63rem;color:#b0a898;font-family:'DM Sans',sans-serif;
             line-height:1.5;font-style:italic;border-top:1px solid #ede7db;padding-top:.65rem;}
    [data-theme="dark"] .LEGHINT{color:#4e4540;border-color:#2a2520;}
    .MSEP{border:none;border-top:1px solid #e8e0d4;margin:3rem 0;}
    [data-theme="dark"] .MSEP{border-color:#1e1b18;}
    /* fullscreen overlay */
    #MFSO{position:fixed;inset:0;z-index:99999;background:rgba(4,3,2,.97);
          display:flex;align-items:center;justify-content:center;
          opacity:0;pointer-events:none;transition:opacity .24s;}
    #MFSO.open{opacity:1;pointer-events:all;}
    #MFSO img{max-width:95vw;max-height:92vh;object-fit:contain;border-radius:6px;}
    #MFSO .fc{position:absolute;top:16px;right:20px;width:38px;height:38px;
              background:rgba(255,255,255,.12);border:none;border-radius:50%;
              color:#fff;font-size:1.2rem;cursor:pointer;
              display:flex;align-items:center;justify-content:center;}
    #MFSO .fc:hover{background:rgba(255,255,255,.25);}
    </style>

    <div class="AW">
      <div class="AH">
        <h2 class="AT">Аерофотознімки Дубровиці<span class="AL"></span></h2>
        <p class="AS">Унікальні знімки міста часів Другої світової війни</p>
      </div>

      <!-- MAP 1944 -->
      <div class="ABLK">
        <p class="ABT">Аерофотознімок 24 січня 1944 року</p>
        <div class="AG">
          <div class="MBOX" id="M44">
            <img class="MIMG" id="I44" src="https://i.imgur.com/dyP4WgZ.jpeg" alt="1944" draggable="false">
            <div class="MLAY" id="P44"></div>
            <div class="ZW">
              <button class="ZB" id="z44p">+</button>
              <button class="ZB" id="z44m">&#8722;</button>
              <button class="ZB" id="z44r" style="font-size:.78rem">&#8962;</button>
            </div>
            <button class="FSB" id="fs44">&#x26F6;</button>
            <div class="BADGE"><span class="bl">Аерофотознімок</span><span class="bd">24 Jan 1944</span></div>
          </div>
          <div class="LEG">
            <p class="LEGH">Позначення</p>
            <ul class="LEGL" id="L44"></ul>
            <p class="LEGHINT">Натисніть маркер або пункт · Scroll для збільшення</p>
          </div>
        </div>
      </div>

      <hr class="MSEP">

      <!-- MAP 1943 -->
      <div class="ABLK">
        <p class="ABT">Аерофотознімок жовтень 1943 року</p>
        <div class="AG">
          <div class="MBOX" id="M43">
            <img class="MIMG" id="I43" src="https://i.imgur.com/EhsjkKX.jpeg" alt="1943" draggable="false">
            <div class="MLAY" id="P43"></div>
            <div class="ZW">
              <button class="ZB" id="z43p">+</button>
              <button class="ZB" id="z43m">&#8722;</button>
              <button class="ZB" id="z43r" style="font-size:.78rem">&#8962;</button>
            </div>
            <button class="FSB" id="fs43">&#x26F6;</button>
            <div class="BADGE"><span class="bl">Аерофотознімок</span><span class="bd">Oct 1943</span></div>
          </div>
          <div class="LEG">
            <p class="LEGH">Позначення</p>
            <ul class="LEGL" id="L43">
              <li style="font-size:.72rem;color:#a09080;font-family:'DM Sans',sans-serif;padding:.4rem .25rem">Завантаження...</li>
            </ul>
            <p class="LEGHINT">Позначення додаються через адмін-панель</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Shared tooltip (one for both maps) -->
    <div class="MTTIP" id="MTTIP">
      <button class="TTX" id="MTTX">&#x2715;</button>
      <div class="TTR"><span class="TTN" id="MTTN"></span><span class="TTT" id="MTTT"></span></div>
      <span class="TTD" id="MTTD"></span>
    </div>

    <!-- Fullscreen overlay -->
    <div id="MFSO"><button class="fc" id="MFSC">&#x2715;</button><img id="MFSI" src="" alt=""></div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {

      // ── PIN DATA (x,y = % of image width/height, loaded from GitHub) ──
      var DATA = {
        '44': [],
        '43': []
      };

      // ── STATE ──────────────────────────────────────────────────
      var ST = {
        '44': {sc:1, ox:0, oy:0},
        '43': {sc:1, ox:0, oy:0}
      };
      var activeMid = null, activeN = null;

      // ── BUILD PINS ─────────────────────────────────────────────
      function buildPins(mid) {
        var layer = document.getElementById('P'+mid);
        layer.innerHTML = '';
        DATA[mid].forEach(function(p) {
          var el = document.createElement('div');
          el.className = 'PIN';
          el.id = 'PIN_'+mid+'_'+p.n;
          // Start at % position (will be updated by updatePins to px)
          el.style.left = p.x + '%';
          el.style.top  = p.y + '%';
          el.innerHTML = '<div class="PRING"></div><div class="PDOT">'+p.n+'</div>';
          el.addEventListener('click', function(e) {
            e.stopPropagation();
            togglePin(mid, p.n, p.t, p.d, e.clientX, e.clientY);
          });
          layer.appendChild(el);
        });
      }

      function buildLegend(mid) {
        var leg = document.getElementById('L'+mid);
        leg.innerHTML = '';
        DATA[mid].forEach(function(p) {
          var li = document.createElement('li');
          li.className = 'LEGI';
          li.id = 'LI_'+mid+'_'+p.n;
          li.innerHTML = '<span class="LEGN">'+p.n+'</span>'+p.t;
          li.addEventListener('click', function(e) {
            e.stopPropagation();
            var r = document.getElementById('M'+mid).getBoundingClientRect();
            togglePin(mid, p.n, p.t, p.d, r.left + r.width/2, r.top + r.height/3);
          });
          leg.appendChild(li);
        });
      }

      // ── TOGGLE PIN / TOOLTIP ───────────────────────────────────
      function togglePin(mid, n, title, desc, cx, cy) {
        if (activeMid === mid && activeN === n) { hideTooltip(); return; }
        hideTooltip();
        activeMid = mid; activeN = n;
        var pin = document.getElementById('PIN_'+mid+'_'+n);
        var li  = document.getElementById('LI_'+mid+'_'+n);
        if (pin) pin.classList.add('act');
        if (li)  li.classList.add('act');
        showTooltip(n, title, desc, cx, cy);
      }

      function hideTooltip() {
        document.getElementById('MTTIP').classList.remove('show');
        if (activeMid !== null) {
          var pin = document.getElementById('PIN_'+activeMid+'_'+activeN);
          var li  = document.getElementById('LI_'+activeMid+'_'+activeN);
          if (pin) pin.classList.remove('act');
          if (li)  li.classList.remove('act');
        }
        activeMid = null; activeN = null;
      }

      function showTooltip(n, title, desc, cx, cy) {
        document.getElementById('MTTN').textContent = n;
        document.getElementById('MTTT').textContent = title;
        document.getElementById('MTTD').textContent = desc;
        var el = document.getElementById('MTTIP');
        // Measure tooltip after content set
        el.style.visibility = 'hidden';
        el.style.display = 'block';
        el.classList.add('show');
        var tw = el.offsetWidth, th = el.offsetHeight;
        el.style.display = '';
        el.style.visibility = '';
        var vw = window.innerWidth, vh = window.innerHeight;
        // Try right of pin, then left, clamped to viewport
        var lft = cx + 18;
        var top = cy - Math.round(th / 2);
        if (lft + tw > vw - 12) lft = cx - tw - 18;
        if (lft < 12) lft = 12;
        if (top < 12) top = 12;
        if (top + th > vh - 12) top = vh - th - 12;
        el.style.left = lft + 'px';
        el.style.top  = top + 'px';
      }

      document.getElementById('MTTX').addEventListener('click', function(e) {
        e.stopPropagation(); hideTooltip();
      });

      // ── ZOOM & PAN MATH ────────────────────────────────────────
      // Image transforms: translate(ox,oy) scale(sc) with transform-origin:center center
      // Pin positions: recalculated from % to px accounting for the transform

      function clamp(mid) {
        var s = ST[mid];
        var img = document.getElementById('I'+mid);
        var w = img.offsetWidth || 0, h = img.offsetHeight || 0;
        var maxOx = w/2 * (s.sc - 1);
        var maxOy = h/2 * (s.sc - 1);
        s.ox = Math.max(-maxOx, Math.min(maxOx, s.ox));
        s.oy = Math.max(-maxOy, Math.min(maxOy, s.oy));
      }

      function applyTransform(mid, animate) {
        var s = ST[mid];
        var img = document.getElementById('I'+mid);
        img.style.transition = animate ? 'transform .28s ease' : 'none';
        img.style.transform = 'translate('+s.ox+'px,'+s.oy+'px) scale('+s.sc+')';
        updatePinPositions(mid);
      }

      // Pins: their "base" position is (x%*w, y%*h) relative to image rendered area.
      // After transform: center=(w/2,h/2), so transformed pos =
      //   center + (base - center) * sc + offset
      function updatePinPositions(mid) {
        var s = ST[mid];
        var img = document.getElementById('I'+mid);
        // Use actual rendered image dimensions (image expands box height)
        var w = img.offsetWidth, h = img.offsetHeight;
        if (!w || !h) return;
        var cx = w/2, cy = h/2;
        DATA[mid].forEach(function(p) {
          var pin = document.getElementById('PIN_'+mid+'_'+p.n);
          if (!pin) return;
          var bx = p.x/100 * w;
          var by = p.y/100 * h;
          var nx = cx + (bx - cx)*s.sc + s.ox;
          var ny = cy + (by - cy)*s.sc + s.oy;
          pin.style.left = nx + 'px';
          pin.style.top  = ny + 'px';
          // hide if out of bounds
          var vis = (nx>-15&&nx<w+15&&ny>-15&&ny<h+15);
          pin.style.opacity = vis ? '1' : '0';
          pin.style.pointerEvents = vis ? 'all' : 'none';
        });
      }

      function doZoom(mid, delta, pivotX, pivotY) {
        var s = ST[mid];
        var img = document.getElementById('I'+mid);
        var w = img.offsetWidth || 0, h = img.offsetHeight || 0;
        var oldSc = s.sc;
        s.sc = Math.min(6, Math.max(1, s.sc + delta));
        if (s.sc === oldSc) return;
        var px = (pivotX !== undefined) ? pivotX : w/2;
        var py = (pivotY !== undefined) ? pivotY : h/2;
        var rx = px - w/2;
        var ry = py - h/2;
        s.ox = rx - (rx - s.ox) * (s.sc / oldSc);
        s.oy = ry - (ry - s.oy) * (s.sc / oldSc);
        clamp(mid);
        applyTransform(mid, true);
      }

      function doReset(mid) {
        ST[mid].sc = 1; ST[mid].ox = 0; ST[mid].oy = 0;
        applyTransform(mid, true);
        hideTooltip();
      }

      // ── BUTTON EVENTS ──────────────────────────────────────────
      ['44','43'].forEach(function(mid) {
        document.getElementById('z'+mid+'p').addEventListener('click', function(e) {
          e.stopPropagation(); doZoom(mid, 0.4);
        });
        document.getElementById('z'+mid+'m').addEventListener('click', function(e) {
          e.stopPropagation(); doZoom(mid, -0.4);
        });
        document.getElementById('z'+mid+'r').addEventListener('click', function(e) {
          e.stopPropagation(); doReset(mid);
        });
        document.getElementById('fs'+mid).addEventListener('click', function(e) {
          e.stopPropagation();
          var src = document.getElementById('I'+mid).src;
          document.getElementById('MFSI').src = src;
          document.getElementById('MFSO').classList.add('open');
        });
      });

      // ── DRAG & WHEEL ───────────────────────────────────────────
      ['44','43'].forEach(function(mid) {
        var box = document.getElementById('M'+mid);
        var dragging = false, startX=0, startY=0;

        box.addEventListener('mousedown', function(e) {
          if (e.button !== 0) return;
          if (e.target.closest('.PIN') || e.target.closest('.ZB') || e.target.closest('.FSB')) return;
          dragging = true;
          startX = e.clientX - ST[mid].ox;
          startY = e.clientY - ST[mid].oy;
        });
        document.addEventListener('mousemove', function(e) {
          if (!dragging) return;
          ST[mid].ox = e.clientX - startX;
          ST[mid].oy = e.clientY - startY;
          clamp(mid); applyTransform(mid, false);
        });
        document.addEventListener('mouseup', function() { dragging = false; });

        box.addEventListener('wheel', function(e) {
          e.preventDefault();
          var img = document.getElementById('I'+mid);
          var rect = img.getBoundingClientRect();
          var px = e.clientX - rect.left;
          var py = e.clientY - rect.top;
          doZoom(mid, e.deltaY < 0 ? 0.25 : -0.25, px, py);
        }, {passive: false});

        // click outside pins
        box.addEventListener('click', function(e) {
          if (!e.target.closest('.PIN')) hideTooltip();
        });

        // touch
        var lastDist = 0, tdragging = false, tsx=0, tsy=0;
        box.addEventListener('touchstart', function(e) {
          if (e.touches.length === 1) {
            tdragging = true;
            tsx = e.touches[0].clientX - ST[mid].ox;
            tsy = e.touches[0].clientY - ST[mid].oy;
          } else if (e.touches.length === 2) {
            tdragging = false;
            lastDist = Math.hypot(
              e.touches[0].clientX - e.touches[1].clientX,
              e.touches[0].clientY - e.touches[1].clientY);
          }
        }, {passive:true});
        box.addEventListener('touchmove', function(e) {
          e.preventDefault();
          if (e.touches.length === 1 && tdragging) {
            ST[mid].ox = e.touches[0].clientX - tsx;
            ST[mid].oy = e.touches[0].clientY - tsy;
            clamp(mid); applyTransform(mid, false);
          } else if (e.touches.length === 2) {
            var d = Math.hypot(
              e.touches[0].clientX - e.touches[1].clientX,
              e.touches[0].clientY - e.touches[1].clientY);
            doZoom(mid, (d - lastDist) * 0.015);
            lastDist = d;
          }
        }, {passive: false});
        box.addEventListener('touchend', function() { tdragging = false; });
      });

      // ── FULLSCREEN ─────────────────────────────────────────────
      document.getElementById('MFSC').addEventListener('click', function() {
        document.getElementById('MFSO').classList.remove('open');
      });
      document.getElementById('MFSO').addEventListener('click', function(e) {
        if (e.target === this) this.classList.remove('open');
      });
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          hideTooltip();
          document.getElementById('MFSO').classList.remove('open');
        }
      });

      // ── LOAD PINS FROM GITHUB ──────────────────────────────────
      // Unified pin format: {id, x, y, title, desc} where x,y are 0-100 percentages
      function normalizePin(p) {
        // Support both {x,y} percent and {cx,cy} SVG-coord formats
        var x = p.x !== undefined ? p.x : (p.pct ? p.pct.x : undefined);
        var y = p.y !== undefined ? p.y : (p.pct ? p.pct.y : undefined);
        return {
          n: p.id || p.n,
          x: parseFloat(x),
          y: parseFloat(y),
          t: p.title || p.t || '',
          d: p.desc  || p.d || ''
        };
      }

      function loadMap(mid, file, legId) {
        var leg = document.getElementById(legId);
        fetch('https://raw.githubusercontent.com/jerkinsmichael13-stack/Dubrovytsia1/main/' + file + '?v=' + Date.now())
          .then(function(r) { return r.ok ? r.json() : []; })
          .then(function(data) {
            if (!Array.isArray(data) || !data.length) {
              if (leg) leg.innerHTML = '<li style="font-size:.72rem;color:#a09080;font-family:\'DM Sans\',sans-serif;padding:.4rem .25rem">Позначень ще немає</li>';
              return;
            }
            DATA[mid] = data.map(normalizePin).filter(function(p){ return !isNaN(p.x) && !isNaN(p.y); });
            buildPins(mid);
            buildLegend(mid);
            setTimeout(function(){ updatePinPositions(mid); }, 30);
          })
          .catch(function() {
            if (leg) leg.innerHTML = '<li style="font-size:.72rem;color:#a09080;font-family:\'DM Sans\',sans-serif;padding:.4rem .25rem">Помилка завантаження</li>';
          });
      }

      loadMap('44', 'aerial_pins_1944.json', 'L44');
      loadMap('43', 'aerial_pins_1943.json', 'L43');

      // Also update on window resize
      window.addEventListener('resize', function() {
        updatePinPositions('44');
        updatePinPositions('43');
      });

    }); // end DOMContentLoaded
    </script>
    </section>
    <!-- ═══ END AERIAL MAPS ═══ -->

    
    
    
    
        <!-- Timeline Preview -->
    <section class="timeline-section">
        <div class="container">
            <h2 class="section-title fade-in-up">Ключові моменти історії</h2>
            <div class="timeline">
                <div class="timeline-item fade-in-up">
                    <div class="timeline-year">1005</div>
                    <div class="timeline-content">
                        <h3>Перша згадка</h3>
                        <p>Володимир Великий засновує єпископську кафедру в Турові, Дубровиця згадується серед міст єпархії</p>
                    </div>
                </div>
                <div class="timeline-item fade-in-up delay-1">
                    <div class="timeline-year">XII ст.</div>
                    <div class="timeline-content">
                        <h3>Столиця князівства</h3>
                        <p>Дубровиця стає центром окремого удільного князівства</p>
                    </div>
                </div>
                <div class="timeline-item fade-in-up delay-2">
                    <div class="timeline-year">1695-1702</div>
                    <div class="timeline-content">
                        <h3>Костел Іоана Хрестителя</h3>
                        <p>Спорудження костелу та колегіуму ордена піярів</p>
                    </div>
                </div>
                <div class="timeline-item fade-in-up delay-3">
                    <div class="timeline-year">1940</div>
                    <div class="timeline-content">
                        <h3>Статус міста</h3>
                        <p>Дубровиця офіційно стає містом та районним центром</p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h4 class="footer-title">Дубровиця</h4>
                    <p class="footer-text">
                        Цифровий архів історичної спадщини селища міського типу Дубровиця, 
                        Сарненський район, Рівненська область, Україна.
                    </p>
                </div>
                <div class="footer-section">
                    <h4 class="footer-title">Навігація</h4>
                    <nav class="footer-nav">
                        <a href="history.html">Історія</a>
                        <a href="photo-archive.html">Фотоархів</a>
                        <a href="metrychni-knyhy.html">Метричні книги</a>
                        <a href="books.html">Книги</a>
                    </nav>
                </div>
                <div class="footer-section">
                    <h4 class="footer-title">Контакти</h4>
                    <p class="footer-text">
                        Маєте матеріали або пропозиції?<br>
                        <a href="contacts.html" class="footer-link">Зв'яжіться з нами</a>
                    </p>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2026 Дубровиця. Цифровий архів.</p>
            </div>
        </div>
    </footer>

    <script src="script.js"></script>
</body>
</html>
