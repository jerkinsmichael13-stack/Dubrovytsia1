<!DOCTYPE html>
<html lang="uk" data-theme="light">
<head>
    <meta charset="UTF-8">
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="manifest" href="site.webmanifest">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—å ‚Äî –î—É–±—Ä–æ–≤–∏—Ü—è</title>
    <script>!function(){var t=localStorage.getItem('theme')||'light';document.documentElement.setAttribute('data-theme',t)}()</script>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;500;600;700&family=DM+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* ============================================
           –ê–î–ú–Ü–ù –ü–ê–ù–ï–õ–¨ - –°–¢–ò–õ–Ü
        ============================================ */
        .admin-wrap {
            max-width: 860px;
            margin: 2rem auto;
            padding: 0 1.5rem 4rem;
        }

        .admin-card {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 1.25rem;
            padding: 2rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 24px rgba(0,0,0,0.07);
        }

        .admin-card h2 {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.6rem;
            font-weight: 600;
            margin-bottom: 1.25rem;
            color: var(--color-text);
        }

        .admin-card h3 {
            font-size: 1rem;
            font-weight: 600;
            margin: 1.25rem 0 0.4rem;
            color: var(--color-text);
        }

        /* ---- Inputs ---- */
        .field {
            margin-bottom: 1rem;
        }
        .field label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.35rem;
            color: var(--color-text-secondary);
            letter-spacing: 0.02em;
        }
        .field input,
        .field select,
        .field textarea {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid var(--color-border);
            border-radius: 0.625rem;
            font-size: 0.9375rem;
            font-family: 'DM Sans', sans-serif;
            background: var(--color-bg);
            color: var(--color-text);
            transition: border-color 0.2s;
            box-sizing: border-box;
        }
        .field input:focus,
        .field select:focus,
        .field textarea:focus {
            outline: none;
            border-color: var(--color-primary);
        }
        .field input[type="password"] {
            letter-spacing: 0.1em;
        }

        /* ---- Buttons ---- */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.75rem;
            border: none;
            border-radius: 0.625rem;
            font-size: 0.9375rem;
            font-weight: 600;
            font-family: 'DM Sans', sans-serif;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-primary {
            background: var(--color-primary);
            color: white;
        }
        .btn-primary:hover { opacity: 0.88; transform: translateY(-1px); }
        .btn-green { background: #2e7d32; color: white; }
        .btn-green:hover { opacity: 0.88; }
        .btn-red { background: #c62828; color: white; }
        .btn-red:hover { opacity: 0.88; }
        .btn-outline {
            background: transparent;
            border: 2px solid var(--color-border);
            color: var(--color-text);
        }
        .btn-outline:hover { border-color: var(--color-primary); color: var(--color-primary); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

        /* ---- Notices ---- */
        .notice {
            padding: 1rem 1.25rem;
            border-radius: 0.75rem;
            margin: 1rem 0;
            font-size: 0.9rem;
            line-height: 1.6;
        }
        .notice-info { background: #e3f2fd; border-left: 4px solid #1976d2; color: #0d47a1; }
        .notice-warn { background: #fff8e1; border-left: 4px solid #f9a825; color: #6d4c00; }
        .notice-success { background: #e8f5e9; border-left: 4px solid #2e7d32; color: #1b5e20; }
        .notice-error { background: #ffebee; border-left: 4px solid #c62828; color: #7f0000; }
        [data-theme="dark"] .notice-info { background: #0d2a4a; color: #90caf9; }
        [data-theme="dark"] .notice-warn { background: #3e2a00; color: #ffe082; }
        [data-theme="dark"] .notice-success { background: #0a2e12; color: #a5d6a7; }
        [data-theme="dark"] .notice-error { background: #3e0a0a; color: #ef9a9a; }

        /* ---- Status message ---- */
        #statusMsg {
            display: none;
            margin-top: 1rem;
            font-weight: 600;
        }

        /* ---- Photo preview ---- */
        #photoPreview {
            display: none;
            width: 100%;
            max-height: 260px;
            object-fit: cover;
            border-radius: 0.75rem;
            margin-top: 0.75rem;
            border: 2px solid var(--color-border);
        }

        /* ---- Photo list ---- */
        .photo-list {
            display: grid;
            gap: 0.75rem;
        }
        .photo-item {
            display: grid;
            grid-template-columns: 72px 1fr auto;
            align-items: center;
            gap: 1rem;
            padding: 0.875rem;
            background: var(--color-bg);
            border: 1px solid var(--color-border);
            border-radius: 0.75rem;
        }
        .photo-item img {
            width: 72px;
            height: 52px;
            object-fit: cover;
            border-radius: 0.5rem;
        }
        .photo-item-info h4 {
            font-size: 0.875rem;
            font-weight: 600;
            margin: 0 0 0.2rem;
        }
        .photo-item-info p {
            font-size: 0.75rem;
            color: var(--color-text-secondary);
            margin: 0;
        }
        .badge {
            display: inline-block;
            padding: 0.15rem 0.5rem;
            border-radius: 999px;
            font-size: 0.7rem;
            font-weight: 600;
            background: var(--color-primary);
            color: white;
            margin-right: 0.25rem;
        }

        /* ---- Token input with toggle ---- */
        .token-row {
            display: flex;
            gap: 0.5rem;
        }
        .token-row input { flex: 1; }

        /* ---- Step indicators ---- */
        .steps { counter-reset: step; }
        .step-item {
            display: flex;
            gap: 1rem;
            margin-bottom: 0.875rem;
            align-items: flex-start;
        }
        .step-item::before {
            counter-increment: step;
            content: counter(step);
            min-width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--color-primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: 700;
            margin-top: 0.1rem;
        }
        .step-item p { margin: 0; line-height: 1.55; font-size: 0.9rem; }
        .step-item a { color: var(--color-primary); }

        /* ---- Tabs ---- */
        .tabs {
            display: flex;
            gap: 0.25rem;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid var(--color-border);
        }
        .tab-btn {
            padding: 0.6rem 1.2rem;
            border: none;
            background: none;
            font-family: 'DM Sans', sans-serif;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--color-text-secondary);
            cursor: pointer;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
            transition: all 0.2s;
        }
        .tab-btn.active { color: var(--color-primary); border-bottom-color: var(--color-primary); }
        .tab-panel { display: none; }
        .tab-panel.active { display: block; }

        /* ---- Loader ---- */
        .spinner-sm {
            width: 18px; height: 18px;
            border: 2px solid rgba(255,255,255,0.4);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.7s linear infinite;
            display: inline-block;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* ---- Upload area ---- */
        .upload-area {
            border: 2px dashed var(--color-border);
            border-radius: 0.75rem;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 1rem;
        }
        .upload-area:hover, .upload-area.drag-over {
            border-color: var(--color-primary);
            background: rgba(26, 86, 50, 0.04);
        }
        .upload-area p { margin: 0.5rem 0 0; font-size: 0.875rem; color: var(--color-text-secondary); }

        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        @media (max-width: 600px) { .grid-2 { grid-template-columns: 1fr; } }
    </style>
    <link rel="stylesheet" href="style_premium.css">
</head>
<body>

<!-- ==================== HEADER ==================== -->
<header class="header">
    <div class="header-container">
        <a href="index.html" class="logo">
            <img src="https://i.imgur.com/mXCrjjG.png" alt="–ì–µ—Ä–±" class="logo-img">
            <div class="logo-text">
                <span class="logo-city">–î—É–±—Ä–æ–≤–∏—Ü—è</span>
                <span class="logo-subtitle">–ê–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—å</span>
            </div>
        </a>
        <div style="display:flex;gap:0.75rem;align-items:center;">
            <a href="index.html" class="btn btn-outline" style="padding:0.5rem 1rem;font-size:0.875rem;">‚Üê –ù–∞ —Å–∞–π—Ç</a>
            <button class="theme-toggle" id="themeToggle" aria-label="–¢–µ–º–∞">
                <svg class="theme-icon sun-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
                <svg class="theme-icon moon-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
            </button>
        </div>
    </div>
</header>

<!-- ==================== MAIN ==================== -->
<div class="admin-wrap">

    <!-- ===== LOGIN ===== -->
    <div id="loginCard" class="admin-card">
        <h2>üîê –í—Ö—ñ–¥ –≤ –∞–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—å</h2>
        <div class="notice notice-info">
            –¢—ñ–ª—å–∫–∏ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä —Å–∞–π—Ç—É –º–æ–∂–µ –¥–æ–¥–∞–≤–∞—Ç–∏ —Ç–∞ –≤–∏–¥–∞–ª—è—Ç–∏ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ—ñ—ó.
        </div>
        <div class="field">
            <label>–ü–∞—Ä–æ–ª—å –∞–¥–º—ñ–Ω–∞</label>
            <input type="password" id="loginPassword" placeholder="–í–≤–µ–¥—ñ—Ç—å –ø–∞—Ä–æ–ª—å" autocomplete="off">
        </div>
        <button class="btn btn-primary" id="loginBtn">–£–≤—ñ–π—Ç–∏</button>
        <div id="loginError" class="notice notice-error" style="display:none;">‚ùå –ù–µ–≤—ñ—Ä–Ω–∏–π –ø–∞—Ä–æ–ª—å</div>
    </div>

    <!-- ===== ADMIN CONTENT ===== -->
    <div id="adminContent" style="display:none;">

        <!-- GitHub Token Setup -->
        <div class="admin-card" id="tokenCard">
            <h2>‚öôÔ∏è –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è GitHub</h2>

            <div id="tokenSetupSection">
                <div class="notice notice-warn">
                    <strong>–û–¥–Ω–æ—Ä–∞–∑–æ–≤–µ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è!</strong> –í–∞–º –ø–æ—Ç—Ä—ñ–±–µ–Ω GitHub Personal Access Token, —â–æ–± –∞–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—å –º–æ–≥–ª–∞ –∑–±–µ—Ä—ñ–≥–∞—Ç–∏ —Ñ–æ—Ç–æ –±–µ–∑–ø–æ—Å–µ—Ä–µ–¥–Ω—å–æ –Ω–∞ GitHub –±–µ–∑ —Ä—É—á–Ω–æ–≥–æ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –∫–æ–¥—É.
                </div>

                <div class="notice notice-info steps">
                    <strong>–Ø–∫ –æ—Ç—Ä–∏–º–∞—Ç–∏ —Ç–æ–∫–µ–Ω (1 —Ö–≤–∏–ª–∏–Ω–∞):</strong>
                    <div class="step-item"><p>–ü–µ—Ä–µ–π–¥—ñ—Ç—å –Ω–∞ <a href="https://github.com/settings/tokens/new" target="_blank"><strong>github.com/settings/tokens/new</strong></a></p></div>
                    <div class="step-item"><p>–£ –ø–æ–ª—ñ <strong>"Note"</strong> –Ω–∞–ø–∏—à—ñ—Ç—å: <code>–î—É–±—Ä–æ–≤–∏—Ü—è –∞—Ä—Ö—ñ–≤</code></p></div>
                    <div class="step-item"><p>–£ <strong>"Expiration"</strong> –æ–±–µ—Ä—ñ—Ç—å <strong>"No expiration"</strong></p></div>
                    <div class="step-item"><p>–ü–æ—Å—Ç–∞–≤—Ç–µ –≥–∞–ª–æ—á–∫—É <strong>"repo"</strong> (–ø–µ—Ä—à–∏–π –ø—É–Ω–∫—Ç —É —Å–ø–∏—Å–∫—É)</p></div>
                    <div class="step-item"><p>–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –∑–µ–ª–µ–Ω—É –∫–Ω–æ–ø–∫—É <strong>"Generate token"</strong></p></div>
                    <div class="step-item"><p>–°–∫–æ–ø—ñ—é–π—Ç–µ —Ç–æ–∫–µ–Ω (–≤—ñ–Ω –ø–æ—á–∏–Ω–∞—î—Ç—å—Å—è –∑ <code>ghp_</code>) —ñ –≤—Å—Ç–∞–≤—Ç–µ –Ω–∏–∂—á–µ</p></div>
                </div>

                <div class="field">
                    <label>GitHub Personal Access Token</label>
                    <div class="token-row">
                        <input type="password" id="githubToken" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx">
                        <button class="btn btn-outline" id="toggleToken" style="white-space:nowrap;">–ü–æ–∫–∞–∑–∞—Ç–∏</button>
                    </div>
                </div>
                <button class="btn btn-primary" id="saveTokenBtn">‚úÖ –ó–±–µ—Ä–µ–≥—Ç–∏ —Ç–æ–∫–µ–Ω</button>
            </div>

            <div id="tokenOkSection" style="display:none;" class="notice notice-success">
                ‚úÖ –¢–æ–∫–µ–Ω –∑–±–µ—Ä–µ–∂–µ–Ω–æ. GitHub API –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ. <button class="btn btn-outline" id="changeTokenBtn" style="margin-left:0.5rem;padding:0.3rem 0.75rem;font-size:0.8rem;">–ó–º—ñ–Ω–∏—Ç–∏</button>
            </div>
        </div>

        <!-- Content Type Selector + Tabs -->
        <div class="admin-card">
            <!-- –í–∏–±—ñ—Ä —Ç–∏–ø—É –∫–æ–Ω—Ç–µ–Ω—Ç—É -->
            <div style="margin-bottom:1.5rem;">
                <h2 style="font-family:'Cormorant Garamond',serif;font-size:1.4rem;margin-bottom:1rem;color:var(--color-text);">–©–æ –≤–∏ —Ö–æ—á–µ—Ç–µ –¥–æ–¥–∞—Ç–∏?</h2>
                <div style="display:flex;gap:0.75rem;flex-wrap:wrap;">
                    <button class="content-type-btn" data-type="photo" style="display:flex;align-items:center;gap:0.5rem;padding:0.75rem 1.25rem;border-radius:0.75rem;border:2px solid var(--color-primary);background:var(--color-primary);color:white;font-family:'DM Sans',sans-serif;font-size:0.9rem;font-weight:600;cursor:pointer;transition:all 0.2s;">üì∏ –§–æ—Ç–æ –¥–æ –∞—Ä—Ö—ñ–≤—É</button>
                    <button class="content-type-btn" data-type="book" style="display:flex;align-items:center;gap:0.5rem;padding:0.75rem 1.25rem;border-radius:0.75rem;border:2px solid var(--color-border);background:transparent;color:var(--color-text);font-family:'DM Sans',sans-serif;font-size:0.9rem;font-weight:600;cursor:pointer;transition:all 0.2s;">üìö –ö–Ω–∏–≥–∞ –ø—Ä–æ –î—É–±—Ä–æ–≤–∏—Ü—é</button>
                    <button class="content-type-btn" data-type="metric" style="display:flex;align-items:center;gap:0.5rem;padding:0.75rem 1.25rem;border-radius:0.75rem;border:2px solid var(--color-border);background:transparent;color:var(--color-text);font-family:'DM Sans',sans-serif;font-size:0.9rem;font-weight:600;cursor:pointer;transition:all 0.2s;">üìñ –ú–µ—Ç—Ä–∏—á–Ω–∞ –∫–Ω–∏–≥–∞</button>
                    <button class="content-type-btn" data-type="pin" style="display:flex;align-items:center;gap:0.5rem;padding:0.75rem 1.25rem;border-radius:0.75rem;border:2px solid var(--color-border);background:transparent;color:var(--color-text);font-family:'DM Sans',sans-serif;font-size:0.9rem;font-weight:600;cursor:pointer;transition:all 0.2s;">üìç –ü—ñ–Ω–∏ –∫–æ—Å—Ç–µ–ª—É</button>
                </div>
            </div>

            <!-- Tabs (–î–æ–¥–∞—Ç–∏ / –°–ø–∏—Å–æ–∫) -->
            <div class="tabs" id="tabsRow">
                <button class="tab-btn active" data-tab="add">‚ûï –î–æ–¥–∞—Ç–∏</button>
                <button class="tab-btn" data-tab="list">üìã –°–ø–∏—Å–æ–∫</button>
            </div>

            <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TAB: ADD ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
            <div class="tab-panel active" id="tab-add">

                <!-- ‚îÄ‚îÄ –§–û–†–ú–ê: –§–û–¢–û ‚îÄ‚îÄ -->
                <div class="content-form active" id="form-photo">
                    <h3 style="font-family:'Cormorant Garamond',serif;font-size:1.4rem;margin-bottom:1.25rem;">–î–æ–¥–∞—Ç–∏ —Ñ–æ—Ç–æ –¥–æ –∞—Ä—Ö—ñ–≤—É</h3>
                    <div class="notice notice-info" style="margin-bottom:1.5rem;">
                        <strong>–Ø–∫ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Ñ–æ—Ç–æ:</strong> –ü–µ—Ä–µ–π–¥—ñ—Ç—å –Ω–∞ <a href="https://imgur.com/upload" target="_blank"><strong>imgur.com/upload</strong></a>, –∑–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ —Ñ–æ—Ç–æ, –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å –ø—Ä–∞–≤–æ—é –∫–Ω–æ–ø–∫–æ—é ‚Üí <strong>"–ö–æ–ø—ñ—é–≤–∞—Ç–∏ –∞–¥—Ä–µ—Å—É –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è"</strong>. –î–ª—è –æ—Ä–∏–≥—ñ–Ω–∞–ª—É –∑–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ —Ñ–∞–π–ª –Ω–∞ Google Drive —ñ —Å–∫–æ–ø—ñ—é–π—Ç–µ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –¥–ª—è –ø–µ—Ä–µ–≥–ª—è–¥—É.
                    </div>

                    <div class="field">
                        <label>–ü–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ —Ñ–æ—Ç–æ (URL) ‚Äî –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –Ω–∞ —Å–∞–π—Ç—ñ *</label>
                        <input type="url" id="newPhotoUrl" placeholder="https://i.imgur.com/abc123.jpg">
                        <img id="photoPreview" src="" alt="–ü–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –ø–µ—Ä–µ–≥–ª—è–¥" style="display:none;width:100%;max-height:240px;object-fit:cover;border-radius:0.75rem;margin-top:0.75rem;border:2px solid var(--color-border);">
                    </div>

                    <div class="field">
                        <label>–ü–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ –æ—Ä–∏–≥—ñ–Ω–∞–ª (Google Drive) ‚Äî –Ω–µ–æ–±–æ–≤'—è–∑–∫–æ–≤–æ</label>
                        <input type="url" id="newPhotoOriginalUrl" placeholder="https://drive.google.com/file/d/...">
                        <div style="font-size:0.8rem;color:var(--color-text-secondary);margin-top:0.35rem;">üí° –î–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –≤–∞–∂–∫–∏—Ö —Ñ–∞–π–ª—ñ–≤. –£ Google Drive: –ü–ö–ú –Ω–∞ —Ñ–∞–π–ª—ñ ‚Üí –û—Ç—Ä–∏–º–∞—Ç–∏ –ø–æ—Å–∏–ª–∞–Ω–Ω—è ‚Üí –ö–æ–ø—ñ—é–≤–∞—Ç–∏.</div>
                    </div>

                    <div class="field">
                        <label>–ù–∞–∑–≤–∞ —Ñ–æ—Ç–æ *</label>
                        <input type="text" id="newPhotoTitle" placeholder="–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞ –ø–ª–æ—â–∞, 1935 —Ä—ñ–∫">
                    </div>

                    <div class="grid-2">
                        <div class="field">
                            <label>–ü–µ—Ä—ñ–æ–¥ *</label>
                            <select id="newPhotoPeriod">
                                <option value="">–û–±–µ—Ä—ñ—Ç—å...</option>
                                <option value="before-1900">–î–æ 1900</option>
                                <option value="1900-1939">1900‚Äî1939</option>
                                <option value="1939-1945">1939‚Äî1945 (–î—Ä—É–≥–∞ —Å–≤—ñ—Ç–æ–≤–∞)</option>
                                <option value="1945-1991">1945‚Äî1991 (–†–∞–¥—è–Ω—Å—å–∫–∏–π)</option>
                                <option value="after-1991">–ü—ñ—Å–ª—è 1991 (–ù–µ–∑–∞–ª–µ–∂–Ω–∞ –£–∫—Ä–∞—ó–Ω–∞)</option>
                            </select>
                        </div>
                        <div class="field">
                            <label>–ö–∞—Ç–µ–≥–æ—Ä—ñ—è *</label>
                            <select id="newPhotoCategory">
                                <option value="">–û–±–µ—Ä—ñ—Ç—å...</option>
                                <option value="churches">üõê –¶–µ—Ä–∫–≤–∏ —Ç–∞ —Ö—Ä–∞–º–∏</option>
                                <option value="streets">üèòÔ∏è –í—É–ª–∏—Ü—ñ –º—ñ—Å—Ç–∞</option>
                                <option value="people">üë• –õ—é–¥–∏ —Ç–∞ –ø–æ—Ä—Ç—Ä–µ—Ç–∏</option>
                                <option value="architecture">üèõÔ∏è –ê—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞</option>
                                <option value="aerial">‚úàÔ∏è –ê–µ—Ä–æ—Ñ–æ—Ç–æ–∑–Ω—ñ–º–∫–∏</option>
                                <option value="drawings">üé® –ú–∞–ª—é–Ω–∫–∏ —Ç–∞ –≥—Ä–∞–≤—é—Ä–∏</option>
                                <option value="events">üìÖ –Ü—Å—Ç–æ—Ä–∏—á–Ω—ñ –ø–æ–¥—ñ—ó</option>
                            </select>
                        </div>
                    </div>

                    <div class="field">
                        <label>–†—ñ–∫ (–∞–±–æ –ø—Ä–∏–±–ª–∏–∑–Ω–∏–π —Ä—ñ–∫)</label>
                        <input type="text" id="newPhotoDate" placeholder="1935">
                    </div>

                    <button class="btn btn-green" id="publishPhotoBtn">üöÄ –û–ø—É–±–ª—ñ–∫—É–≤–∞—Ç–∏ —Ñ–æ—Ç–æ</button>
                    <div id="statusMsgPhoto" class="notice" style="display:none;margin-top:1rem;"></div>
                </div>

                <!-- ‚îÄ‚îÄ –§–û–†–ú–ê: –ö–ù–ò–ì–ê ‚îÄ‚îÄ -->
                <div class="content-form" id="form-book" style="display:none;">
                    <h3 style="font-family:'Cormorant Garamond',serif;font-size:1.4rem;margin-bottom:1.25rem;">–î–æ–¥–∞—Ç–∏ –∫–Ω–∏–≥—É –ø—Ä–æ –î—É–±—Ä–æ–≤–∏—Ü—é</h3>

                    <div class="grid-2">
                        <div class="field">
                            <label>–ù–∞–∑–≤–∞ –∫–Ω–∏–≥–∏ *</label>
                            <input type="text" id="newBookTitle" placeholder="–î—É–±—Ä–æ–≤–∏—Ü—è: –Ü—Å—Ç–æ—Ä—ñ—è —Ç–∞ —Å—É—á–∞—Å–Ω—ñ—Å—Ç—å">
                        </div>
                        <div class="field">
                            <label>–ê–≤—Ç–æ—Ä *</label>
                            <input type="text" id="newBookAuthor" placeholder="–Ü–≤–∞–Ω –ü–µ—Ç—Ä–µ–Ω–∫–æ">
                        </div>
                    </div>

                    <div class="grid-2">
                        <div class="field">
                            <label>–†—ñ–∫ –≤–∏–¥–∞–Ω–Ω—è</label>
                            <input type="text" id="newBookYear" placeholder="2015">
                        </div>
                        <div class="field">
                            <label>–¢–µ–º–∞—Ç–∏—á–Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä—ñ—è *</label>
                            <select id="newBookCategory">
                                <option value="">–û–±–µ—Ä—ñ—Ç—å...</option>
                                <option value="history">–Ü—Å—Ç–æ—Ä—ñ—è</option>
                                <option value="culture">–ö—É–ª—å—Ç—É—Ä–∞ —Ç–∞ —Å–ø–∞–¥—â–∏–Ω–∞</option>
                                <option value="war">–î—Ä—É–≥–∞ —Å–≤—ñ—Ç–æ–≤–∞</option>
                                <option value="religion">–†–µ–ª—ñ–≥—ñ—è —Ç–∞ —Ü–µ—Ä–∫–≤–∏</option>
                                <option value="people">–í–∏–¥–∞—Ç–Ω—ñ –ø–æ—Å—Ç–∞—Ç—ñ</option>
                                <option value="documents">–î–æ–∫—É–º–µ–Ω—Ç–∏ —Ç–∞ –∞—Ä—Ö—ñ–≤–∏</option>
                                <option value="folklore">–§–æ–ª—å–∫–ª–æ—Ä —Ç–∞ –ª–µ–≥–µ–Ω–¥–∏</option>
                            </select>
                        </div>
                    </div>
                    <div class="field">
                        <label>–ú—ñ—Å—Ü–µ –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è</label>
                        <input type="text" id="newBookLocation" placeholder="–†—ñ–≤–Ω–µ–Ω—Å—å–∫–∞ –æ–±–ª–∞—Å–Ω–∞ –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∞">
                    </div>

                    <div class="field">
                        <label>–û–ø–∏—Å –∫–Ω–∏–≥–∏ *</label>
                        <textarea id="newBookDescription" rows="4" placeholder="–ö–æ—Ä–æ—Ç–∫–∏–π –æ–ø–∏—Å –∑–º—ñ—Å—Ç—É –∫–Ω–∏–≥–∏..."></textarea>
                    </div>

                    <div class="field">
                        <label>–û–±–∫–ª–∞–¥–∏–Ω–∫–∞ (URL –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è)</label>
                        <input type="url" id="newBookCoverUrl" placeholder="https://i.imgur.com/abc123.jpg">
                        <div style="font-size:0.8rem;color:var(--color-text-secondary);margin-top:0.35rem;">–ù–µ–æ–±–æ–≤'—è–∑–∫–æ–≤–æ. –Ø–∫—â–æ –Ω–µ –≤–∫–∞–∑–∞–Ω–æ ‚Äî –±—É–¥–µ –ø–æ–∫–∞–∑–∞–Ω–æ —ñ–∫–æ–Ω–∫—É –∫–Ω–∏–≥–∏.</div>
                    </div>

                    <div class="field">
                        <label>–ü–æ—Å–∏–ª–∞–Ω–Ω—è –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è (Google Drive / PDF)</label>
                        <input type="url" id="newBookDownloadUrl" placeholder="https://drive.google.com/file/d/...">
                        <div style="font-size:0.8rem;color:var(--color-text-secondary);margin-top:0.35rem;">–ù–µ–æ–±–æ–≤'—è–∑–∫–æ–≤–æ. –Ø–∫—â–æ —î —Ü–∏—Ñ—Ä–æ–≤–∞ –∫–æ–ø—ñ—è ‚Äî –≤—Å—Ç–∞–≤—Ç–µ –ø–æ—Å–∏–ª–∞–Ω–Ω—è.</div>
                    </div>

                    <button class="btn btn-green" id="publishBookBtn">üìö –î–æ–¥–∞—Ç–∏ –∫–Ω–∏–≥—É –¥–æ –∫–∞—Ç–∞–ª–æ–≥—É</button>
                    <div id="statusMsgBook" class="notice" style="display:none;margin-top:1rem;"></div>
                </div>

                <!-- ‚îÄ‚îÄ –§–û–†–ú–ê: –ú–ï–¢–†–ò–ß–ù–ê –ö–ù–ò–ì–ê ‚îÄ‚îÄ -->
                <div class="content-form" id="form-metric" style="display:none;">
                    <h3 style="font-family:'Cormorant Garamond',serif;font-size:1.4rem;margin-bottom:1.25rem;">–î–æ–¥–∞—Ç–∏ –º–µ—Ç—Ä–∏—á–Ω—É –∫–Ω–∏–≥—É</h3>

                    <div class="field">
                        <label>–ù–∞–∑–≤–∞ –ø–∞—Ä–∞—Ñ—ñ—ó / —É—Å—Ç–∞–Ω–æ–≤–∏ *</label>
                        <input type="text" id="newMetricParish" placeholder="–°–≤—è—Ç–æ-–ú–∏–∫–æ–ª–∞—ó–≤—Å—å–∫–∞ –ø–∞—Ä–∞—Ñ—ñ—è, –î—É–±—Ä–æ–≤–∏—Ü—è">
                    </div>

                    <div class="grid-2">
                        <div class="field">
                            <label>–†–æ–∫–∏ *</label>
                            <input type="text" id="newMetricYears" placeholder="1875‚Äì1915">
                        </div>
                        <div class="field">
                            <label>–ö–æ–Ω—Ñ–µ—Å—ñ—è *</label>
                            <select id="newMetricConfession">
                                <option value="">–û–±–µ—Ä—ñ—Ç—å...</option>
                                <option value="–ü—Ä–∞–≤–æ—Å–ª–∞–≤–Ω–∞">–ü—Ä–∞–≤–æ—Å–ª–∞–≤–Ω–∞</option>
                                <option value="–†–∏–º–æ-–∫–∞—Ç–æ–ª–∏—Ü—å–∫–∞">–†–∏–º–æ-–∫–∞—Ç–æ–ª–∏—Ü—å–∫–∞</option>
                                <option value="–ì—Ä–µ–∫–æ-–∫–∞—Ç–æ–ª–∏—Ü—å–∫–∞">–ì—Ä–µ–∫–æ-–∫–∞—Ç–æ–ª–∏—Ü—å–∫–∞</option>
                                <option value="–Ü—É–¥–∞—ó–∑–º">–Ü—É–¥–∞—ó–∑–º</option>
                                <option value="–ü—Ä–æ—Ç–µ—Å—Ç–∞–Ω—Ç—Å—å–∫–∞">–ü—Ä–æ—Ç–µ—Å—Ç–∞–Ω—Ç—Å—å–∫–∞</option>
                                <option value="–í—Å—ñ –∫–æ–Ω—Ñ–µ—Å—ñ—ó">–í—Å—ñ –∫–æ–Ω—Ñ–µ—Å—ñ—ó</option>
                            </select>
                        </div>
                    </div>

                    <div class="field">
                        <label>–¢–∏–ø –∑–∞–ø–∏—Å—ñ–≤</label>
                        <div style="display:flex;gap:1rem;flex-wrap:wrap;margin-top:0.25rem;">
                            <label style="display:flex;align-items:center;gap:0.4rem;font-weight:400;cursor:pointer;"><input type="checkbox" id="metricBirth" value="–ù–∞—Ä–æ–¥–∂–µ–Ω–Ω—è"> üë∂ –ù–∞—Ä–æ–¥–∂–µ–Ω–Ω—è</label>
                            <label style="display:flex;align-items:center;gap:0.4rem;font-weight:400;cursor:pointer;"><input type="checkbox" id="metricMarriage" value="–®–ª—é–±–∏"> üíç –®–ª—é–±–∏</label>
                            <label style="display:flex;align-items:center;gap:0.4rem;font-weight:400;cursor:pointer;"><input type="checkbox" id="metricDeath" value="–°–º–µ—Ä—Ç—ñ"> üïäÔ∏è –°–º–µ—Ä—Ç—ñ</label>
                            <label style="display:flex;align-items:center;gap:0.4rem;font-weight:400;cursor:pointer;"><input type="checkbox" id="metricConfessionRec" value="–°–ø–æ–≤—ñ–¥–Ω—ñ –∑–∞–ø–∏—Å–∏"> üìú –°–ø–æ–≤—ñ–¥–Ω—ñ –∑–∞–ø–∏—Å–∏</label>
                        </div>
                    </div>

                    <div class="field">
                        <label>–ù–∞—Å–µ–ª–µ–Ω—ñ –ø—É–Ω–∫—Ç–∏</label>
                        <input type="text" id="newMetricVillages" placeholder="–î—É–±—Ä–æ–≤–∏—Ü—è, –°—Ç–µ–ø–∞–Ω–≥–æ—Ä–æ–¥, –ë—ñ–ª–∫–∞">
                    </div>

                    <div class="field">
                        <label>–ê—Ä—Ö—ñ–≤ —Ç–∞ —Ñ–æ–Ω–¥</label>
                        <input type="text" id="newMetricArchive" placeholder="–î–µ—Ä–∂–∞–≤–Ω–∏–π –∞—Ä—Ö—ñ–≤ –†—ñ–≤–Ω–µ–Ω—Å—å–∫–æ—ó –æ–±–ª–∞—Å—Ç—ñ, —Ñ. 258, –æ–ø. 1">
                    </div>

                    <div class="field">
                        <label>–ü–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ —Å–∫–∞–Ω / Google Drive</label>
                        <input type="url" id="newMetricScanUrl" placeholder="https://drive.google.com/file/d/...">
                        <div style="font-size:0.8rem;color:var(--color-text-secondary);margin-top:0.35rem;">–ù–µ–æ–±–æ–≤'—è–∑–∫–æ–≤–æ. –Ø–∫—â–æ —î —Ü–∏—Ñ—Ä–æ–≤–∞ –∫–æ–ø—ñ—è ‚Äî –≤—Å—Ç–∞–≤—Ç–µ –ø–æ—Å–∏–ª–∞–Ω–Ω—è.</div>
                    </div>

                    <button class="btn btn-green" id="publishMetricBtn">üìñ –î–æ–¥–∞—Ç–∏ –º–µ—Ç—Ä–∏—á–Ω—É –∫–Ω–∏–≥—É</button>
                    <div id="statusMsgMetric" class="notice" style="display:none;margin-top:1rem;"></div>
                </div>

                <!-- ‚îÄ‚îÄ –§–û–†–ú–ê: –ü–Ü–ù –ö–û–°–¢–ï–õ–£ ‚îÄ‚îÄ -->
                <div class="content-form" id="form-pin" style="display:none;">
                    <h3 style="font-family:'Cormorant Garamond',serif;font-size:1.4rem;margin-bottom:1.25rem;">–ü—ñ–Ω–∏ –∫–æ—Å—Ç–µ–ª—É –Ü–æ–∞–Ω–Ω–∞ –•—Ä–µ—Å—Ç–∏—Ç–µ–ª—è</h3>
                    <div class="notice notice-info" style="margin-bottom:1.5rem;">
                        –ü—ñ–Ω–∏ –≤—ñ–¥–æ–±—Ä–∞–∂–∞—é—Ç—å—Å—è –Ω–∞ —Ñ–æ—Ç–æ –∫–æ—Å—Ç–µ–ª—É –Ω–∞ —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ <strong>¬´–ü–∞–º'—è—Ç–∫–∏¬ª</strong>. –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ X —Ç–∞ Y ‚Äî –≤—ñ–¥—Å–æ—Ç–∫–∏ –≤—ñ–¥ —à–∏—Ä–∏–Ω–∏/–≤–∏—Å–æ—Ç–∏ —Ñ–æ—Ç–æ (0‚Äì100). –°—Ç–æ—Ä–æ–Ω–∞: <strong>L</strong> = –ª—ñ–≤–∞ –ø–∞–Ω–µ–ª—å, <strong>R</strong> = –ø—Ä–∞–≤–∞.
                    </div>

                    <div class="grid-2">
                        <div class="field">
                            <label>–ü–æ–∑–∏—Ü—ñ—è X (0‚Äì100) *</label>
                            <input type="number" id="newPinX" placeholder="50" min="0" max="100" step="0.1">
                        </div>
                        <div class="field">
                            <label>–ü–æ–∑–∏—Ü—ñ—è Y (0‚Äì100) *</label>
                            <input type="number" id="newPinY" placeholder="50" min="0" max="100" step="0.1">
                        </div>
                    </div>

                    <div class="grid-2">
                        <div class="field">
                            <label>–°—Ç–æ—Ä–æ–Ω–∞ –∫–∞—Ä—Ç–∫–∏ *</label>
                            <select id="newPinSide">
                                <option value="L">L ‚Äî –õ—ñ–≤–∞ –ø–∞–Ω–µ–ª—å</option>
                                <option value="R">R ‚Äî –ü—Ä–∞–≤–∞ –ø–∞–Ω–µ–ª—å</option>
                            </select>
                        </div>
                        <div class="field">
                            <label>–ú—ñ—Ç–∫–∞ (–º–∞–ª–∏–π –ø—ñ–¥–ø–∏—Å)</label>
                            <input type="text" id="newPinLabel" placeholder="–ë—É–¥—ñ–≤–Ω–∏—Ü—Ç–≤–æ ¬∑ 1695‚Äì1742">
                        </div>
                    </div>

                    <div class="field">
                        <label>–ó–∞–≥–æ–ª–æ–≤–æ–∫ –∫–∞—Ä—Ç–∫–∏ *</label>
                        <input type="text" id="newPinCardTitle" placeholder="–û—Ä–¥–µ–Ω –ø—ñ–∞—Ä—ñ–≤">
                    </div>

                    <div class="field">
                        <label>–¢–µ–∫—Å—Ç –ø–∞—Ä–∞–≥—Ä–∞—Ñ 1 *</label>
                        <textarea id="newPinText1" rows="3" placeholder="–û—Å–Ω–æ–≤–Ω–∏–π –æ–ø–∏—Å..."></textarea>
                    </div>

                    <div class="field">
                        <label>–¢–µ–∫—Å—Ç –ø–∞—Ä–∞–≥—Ä–∞—Ñ 2</label>
                        <textarea id="newPinText2" rows="3" placeholder="–î–æ–¥–∞—Ç–∫–æ–≤–∏–π —Ç–µ–∫—Å—Ç (–Ω–µ–æ–±–æ–≤'—è–∑–∫–æ–≤–æ)..."></textarea>
                    </div>

                    <button class="btn btn-green" id="publishPinBtn">üìç –î–æ–¥–∞—Ç–∏ –ø—ñ–Ω</button>
                    <div id="statusMsgPin" class="notice" style="display:none;margin-top:1rem;"></div>
                </div>

            </div><!-- /tab-add panel -->

            <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TAB: LIST ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
            <div class="tab-panel" id="tab-list">
                <div id="photoListWrap">
                    <p style="color:var(--color-text-secondary);">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</p>
                </div>
            </div>

        </div>


        <!-- ‚ïê‚ïê‚ïê‚ïê MAP EDITOR CARD ‚ïê‚ïê‚ïê‚ïê -->
        <div class="admin-card" id="mapEditorCard" style="margin-top:0;">
            <h2 style="font-family:'Cormorant Garamond',serif;margin-bottom:0.5rem;">üó∫Ô∏è –†–µ–¥–∞–∫—Ç–æ—Ä –∫–∞—Ä—Ç (–ê–µ—Ä–æ—Ñ–æ—Ç–æ–∑–Ω—ñ–º–∫–∏)</h2>
            <p style="font-size:0.85rem;color:var(--color-text-secondary);margin-bottom:1.5rem;">
                –ö–ª—ñ–∫–Ω—ñ—Ç—å –Ω–∞ —Ñ–æ—Ç–æ, —â–æ–± –¥–æ–¥–∞—Ç–∏ –Ω–æ–≤–∏–π –ø—ñ–Ω. –ü–µ—Ä–µ—Ç—è–≥—É–π—Ç–µ —ñ—Å–Ω—É—é—á—ñ –ø—ñ–Ω–∏. –ü—ñ—Å–ª—è —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è ‚Äî –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å ¬´–ó–±–µ—Ä–µ–≥—Ç–∏¬ª.
            </p>

            <!-- Map selector -->
            <div style="display:flex;gap:0.75rem;margin-bottom:1.5rem;flex-wrap:wrap;">
                <button class="map-sel-btn active" data-mapid="1944"
                    style="padding:0.6rem 1.2rem;border-radius:0.6rem;border:2px solid var(--color-primary);
                           background:var(--color-primary);color:#fff;font-family:'DM Sans',sans-serif;
                           font-size:0.875rem;font-weight:600;cursor:pointer;transition:all 0.2s;">
                    üì∏ –ó–Ω—ñ–º–æ–∫ 1944
                </button>
                <button class="map-sel-btn" data-mapid="1943"
                    style="padding:0.6rem 1.2rem;border-radius:0.6rem;border:2px solid var(--color-border);
                           background:transparent;color:var(--color-text);font-family:'DM Sans',sans-serif;
                           font-size:0.875rem;font-weight:600;cursor:pointer;transition:all 0.2s;">
                    üì∏ –ó–Ω—ñ–º–æ–∫ 1943
                </button>
            </div>

            <!-- Editor area -->
            <div id="mapEditorWrap" style="position:relative;border-radius:10px;overflow:hidden;
                 box-shadow:0 4px 20px rgba(0,0,0,0.12);border:2px solid var(--color-border);
                 cursor:crosshair;user-select:none;background:#111;line-height:0;margin-bottom:1.25rem;">
                <img id="editorImg" src="https://i.imgur.com/dyP4WgZ.jpeg"
                     style="width:100%;height:auto;display:block;filter:sepia(0.06) contrast(1.04);pointer-events:none;">
                <svg id="editorSVG" style="position:absolute;top:0;left:0;width:100%;height:100%;overflow:visible;pointer-events:all;"
                     xmlns="http://www.w3.org/2000/svg">
                </svg>
                <!-- Instruction overlay -->
                <div id="editorHint" style="position:absolute;top:10px;left:50%;transform:translateX(-50%);
                     background:rgba(10,8,5,0.82);backdrop-filter:blur(8px);
                     border:1px solid rgba(201,162,39,0.3);border-radius:8px;
                     padding:6px 14px;font-family:'DM Sans',sans-serif;font-size:0.72rem;
                     color:#c9a227;white-space:nowrap;pointer-events:none;">
                    üëÜ –ö–ª—ñ–∫ –Ω–∞ —Ñ–æ—Ç–æ ‚Äî –¥–æ–¥–∞—Ç–∏ –ø—ñ–Ω &nbsp;|&nbsp; –ü–µ—Ä–µ—Ç—è–≥–Ω—É—Ç–∏ –ø—ñ–Ω ‚Äî –ø–µ—Ä–µ–º—ñ—Å—Ç–∏—Ç–∏
                </div>
            </div>

            <!-- Pin list -->
            <div style="margin-bottom:1.25rem;">
                <h3 style="font-size:0.95rem;font-weight:600;margin-bottom:0.75rem;color:var(--color-text);">–°–ø–∏—Å–æ–∫ –ø—ñ–Ω—ñ–≤</h3>
                <div id="pinListWrap" style="display:flex;flex-direction:column;gap:0.5rem;max-height:320px;overflow-y:auto;"></div>
                <div id="pinListEmpty" style="text-align:center;padding:1.5rem;color:var(--color-text-secondary);font-size:0.875rem;">–ü—ñ–Ω—ñ–≤ —â–µ –Ω–µ–º–∞—î. –ö–ª—ñ–∫–Ω—ñ—Ç—å –Ω–∞ –∫–∞—Ä—Ç—ñ, —â–æ–± –¥–æ–¥–∞—Ç–∏.</div>
            </div>

            <!-- Save -->
            <div style="display:flex;gap:0.75rem;align-items:center;flex-wrap:wrap;">
                <button id="saveMapBtn" class="btn btn-green" style="font-size:0.9rem;">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏ –ø—ñ–Ω–∏ –Ω–∞ GitHub</button>
                <button id="clearAllPinsBtn" class="btn btn-outline" style="font-size:0.875rem;color:#c0392b;border-color:#c0392b;">üóëÔ∏è –í–∏–¥–∞–ª–∏—Ç–∏ –≤—Å—ñ –ø—ñ–Ω–∏</button>
                <button id="copyJsonBtn" class="btn btn-outline" style="font-size:0.875rem;">üìã –°–∫–æ–ø—ñ—é–≤–∞—Ç–∏ JSON</button>
            </div>
            <div id="mapEditorStatus" class="notice" style="display:none;margin-top:1rem;"></div>

            <!-- Modal for new pin info -->
            <div id="pinModal" style="display:none;position:fixed;inset:0;z-index:10000;
                 background:rgba(0,0,0,0.6);backdrop-filter:blur(4px);
                 align-items:center;justify-content:center;">
                <div style="background:var(--color-bg-card);border-radius:14px;padding:1.75rem;
                     width:min(420px,92vw);box-shadow:0 20px 60px rgba(0,0,0,0.3);
                     border:1px solid var(--color-border);">
                    <h3 style="font-family:'Cormorant Garamond',serif;font-size:1.3rem;margin:0 0 1.2rem;color:var(--color-text);">–ù–æ–≤–∏–π –ø—ñ–Ω</h3>
                    <div class="field">
                        <label style="font-size:0.8rem;font-weight:600;color:var(--color-text-secondary);">–ù–∞–∑–≤–∞ *</label>
                        <input id="pinModalTitle" type="text" placeholder="–ö–æ—Å—Ç–µ–ª –Ü–æ–∞–Ω–Ω–∞ –•—Ä–µ—Å—Ç–∏—Ç–µ–ª—è"
                            style="width:100%;padding:0.65rem 0.9rem;border:2px solid var(--color-border);
                            border-radius:8px;font-family:'DM Sans',sans-serif;font-size:0.9rem;
                            background:var(--color-bg);color:var(--color-text);box-sizing:border-box;">
                    </div>
                    <div class="field" style="margin-top:0.75rem;">
                        <label style="font-size:0.8rem;font-weight:600;color:var(--color-text-secondary);">–û–ø–∏—Å (–Ω–µ–æ–±–æ–≤'—è–∑–∫–æ–≤–æ)</label>
                        <textarea id="pinModalDesc" rows="3" placeholder="–ö–æ—Ä–æ—Ç–∫–∏–π –æ–ø–∏—Å –æ–±'—î–∫—Ç–∞..."
                            style="width:100%;padding:0.65rem 0.9rem;border:2px solid var(--color-border);
                            border-radius:8px;font-family:'DM Sans',sans-serif;font-size:0.875rem;
                            background:var(--color-bg);color:var(--color-text);box-sizing:border-box;resize:vertical;"></textarea>
                    </div>
                    <div style="display:flex;gap:0.75rem;margin-top:1.25rem;">
                        <button id="pinModalSave" class="btn btn-primary" style="flex:1;">‚úÖ –î–æ–¥–∞—Ç–∏ –ø—ñ–Ω</button>
                        <button id="pinModalCancel" class="btn btn-outline" style="flex:1;">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                    </div>
                </div>
            </div>

        <!-- ‚ïê‚ïê‚ïê‚ïê KOSTEL PIN EDITOR CARD ‚ïê‚ïê‚ïê‚ïê -->
        <div class="admin-card" id="kostelEditorCard" style="margin-top:0;">
            <h2 style="font-family:'Cormorant Garamond',serif;margin-bottom:0.5rem;">‚õ™ –†–µ–¥–∞–∫—Ç–æ—Ä –ø—ñ–Ω—ñ–≤ ‚Äî –ö–æ—Å—Ç–µ–ª –Ü–æ–∞–Ω–Ω–∞ –•—Ä–µ—Å—Ç–∏—Ç–µ–ª—è</h2>
            <p style="font-size:0.85rem;color:var(--color-text-secondary);margin-bottom:1.5rem;">
                –ö–ª—ñ–∫–Ω—ñ—Ç—å –Ω–∞ —Ñ–æ—Ç–æ –∫–æ—Å—Ç–µ–ª—É, —â–æ–± –¥–æ–¥–∞—Ç–∏ –Ω–æ–≤–∏–π –ø—ñ–Ω-–∞–Ω–æ—Ç–∞—Ü—ñ—é. –í–∫–∞–∂—ñ—Ç—å —Å—Ç–æ—Ä–æ–Ω—É (–ª—ñ–≤–æ/–ø—Ä–∞–≤–æ), –º—ñ—Ç–∫—É, –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Ç–∞ —Ç–µ–∫—Å—Ç. –ü—ñ–Ω–∏ –∑–±–µ—Ä–µ–∂—É—Ç—å—Å—è —É <code>kostel_pins.json</code> —ñ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑'—è–≤–ª—è—Ç—å—Å—è –Ω–∞ —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ –ü–∞–º'—è—Ç–æ–∫.
            </p>

            <!-- Editor area -->
            <div id="kostelEditorWrap" style="position:relative;border-radius:10px;overflow:hidden;
                 box-shadow:0 4px 20px rgba(0,0,0,0.12);border:2px solid var(--color-border);
                 cursor:crosshair;user-select:none;background:#111;line-height:0;margin-bottom:1.25rem;">
                <img id="kostelEditorImg" src="https://i.imgur.com/Ru7uTkK.jpeg"
                     style="width:100%;height:auto;display:block;filter:contrast(1.04) brightness(.93) saturate(.82);pointer-events:none;">
                <svg id="kostelEditorSVG" style="position:absolute;top:0;left:0;width:100%;height:100%;overflow:visible;pointer-events:all;"
                     xmlns="http://www.w3.org/2000/svg">
                </svg>
                <div id="kostelEditorHint" style="position:absolute;top:10px;left:50%;transform:translateX(-50%);
                     background:rgba(10,8,5,0.85);backdrop-filter:blur(8px);
                     border:1px solid rgba(201,162,39,0.35);border-radius:8px;
                     padding:6px 16px;font-family:'DM Sans',sans-serif;font-size:0.72rem;
                     color:#c9a227;white-space:nowrap;pointer-events:none;">
                    üëÜ –ö–ª—ñ–∫ –Ω–∞ —Ñ–æ—Ç–æ ‚Äî –¥–æ–¥–∞—Ç–∏ –ø—ñ–Ω &nbsp;|&nbsp; –ü–µ—Ä–µ—Ç—è–≥–Ω—É—Ç–∏ –ø—ñ–Ω ‚Äî –ø–µ—Ä–µ–º—ñ—Å—Ç–∏—Ç–∏
                </div>
            </div>

            <!-- Pin list -->
            <div style="margin-bottom:1.25rem;">
                <h3 style="font-size:0.95rem;font-weight:600;margin-bottom:0.75rem;color:var(--color-text);">–°–ø–∏—Å–æ–∫ –ø—ñ–Ω—ñ–≤</h3>
                <div id="kostelPinListWrap" style="display:flex;flex-direction:column;gap:0.5rem;max-height:360px;overflow-y:auto;"></div>
                <div id="kostelPinListEmpty" style="text-align:center;padding:1.5rem;color:var(--color-text-secondary);font-size:0.875rem;">–ü—ñ–Ω—ñ–≤ —â–µ –Ω–µ–º–∞—î. –ö–ª—ñ–∫–Ω—ñ—Ç—å –Ω–∞ —Ñ–æ—Ç–æ, —â–æ–± –¥–æ–¥–∞—Ç–∏.</div>
            </div>

            <!-- Actions -->
            <div style="display:flex;gap:0.75rem;align-items:center;flex-wrap:wrap;">
                <button id="kostelSaveBtn" class="btn btn-green" style="font-size:0.9rem;">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏ –ø—ñ–Ω–∏ –Ω–∞ GitHub</button>
                <button id="kostelClearBtn" class="btn btn-outline" style="font-size:0.875rem;color:#c0392b;border-color:#c0392b;">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç–∏ –≤—Å—ñ –ø—ñ–Ω–∏</button>
                <button id="kostelCopyJsonBtn" class="btn btn-outline" style="font-size:0.875rem;">üìã –°–∫–æ–ø—ñ—é–≤–∞—Ç–∏ JSON</button>
            </div>
            <div id="kostelEditorStatus" class="notice" style="display:none;margin-top:1rem;"></div>

            <!-- Modal for new pin -->
            <div id="kostelPinModal" style="display:none;position:fixed;inset:0;z-index:10000;
                 background:rgba(0,0,0,0.65);backdrop-filter:blur(5px);
                 align-items:center;justify-content:center;">
                <div style="background:var(--color-bg-card);border-radius:14px;padding:1.75rem;
                     width:min(480px,94vw);box-shadow:0 20px 60px rgba(0,0,0,0.35);
                     border:1px solid var(--color-border);max-height:92vh;overflow-y:auto;">
                    <h3 style="font-family:'Cormorant Garamond',serif;font-size:1.3rem;margin:0 0 1.2rem;color:var(--color-text);" id="kostelPinModalTitle">–ù–æ–≤–∏–π –ø—ñ–Ω</h3>

                    <div class="field">
                        <label style="font-size:0.8rem;font-weight:600;color:var(--color-text-secondary);">–°—Ç–æ—Ä–æ–Ω–∞ *</label>
                        <div style="display:flex;gap:0.75rem;margin-top:0.35rem;">
                            <label style="display:flex;align-items:center;gap:0.4rem;cursor:pointer;font-size:0.9rem;">
                                <input type="radio" name="kostelPinSide" id="kostelSideL" value="L" checked> ‚óÄ –õ—ñ–≤–æ—Ä—É—á
                            </label>
                            <label style="display:flex;align-items:center;gap:0.4rem;cursor:pointer;font-size:0.9rem;">
                                <input type="radio" name="kostelPinSide" id="kostelSideR" value="R"> –ü—Ä–∞–≤–æ—Ä—É—á ‚ñ∂
                            </label>
                        </div>
                    </div>
                    <div class="field" style="margin-top:0.75rem;">
                        <label style="font-size:0.8rem;font-weight:600;color:var(--color-text-secondary);">–ú—ñ—Ç–∫–∞ (–Ω–∞–ø—Ä. "–ë—É–¥—ñ–≤–Ω–∏—Ü—Ç–≤–æ ¬∑ 1695‚Äì1742") *</label>
                        <input id="kostelPinLabel" type="text" placeholder="–ë—É–¥—ñ–≤–Ω–∏—Ü—Ç–≤–æ ¬∑ 1695‚Äì1742"
                            style="width:100%;padding:0.65rem 0.9rem;border:2px solid var(--color-border);
                            border-radius:8px;font-family:'DM Sans',sans-serif;font-size:0.9rem;
                            background:var(--color-bg);color:var(--color-text);box-sizing:border-box;">
                    </div>
                    <div class="field" style="margin-top:0.75rem;">
                        <label style="font-size:0.8rem;font-weight:600;color:var(--color-text-secondary);">–ó–∞–≥–æ–ª–æ–≤–æ–∫ –∫–∞—Ä—Ç–∫–∏ *</label>
                        <input id="kostelPinCardTitle" type="text" placeholder="–û—Ä–¥–µ–Ω –ø—ñ–∞—Ä—ñ–≤"
                            style="width:100%;padding:0.65rem 0.9rem;border:2px solid var(--color-border);
                            border-radius:8px;font-family:'DM Sans',sans-serif;font-size:0.9rem;
                            background:var(--color-bg);color:var(--color-text);box-sizing:border-box;">
                    </div>
                    <div class="field" style="margin-top:0.75rem;">
                        <label style="font-size:0.8rem;font-weight:600;color:var(--color-text-secondary);">–¢–µ–∫—Å—Ç (–∞–±–∑–∞—Ü 1)</label>
                        <textarea id="kostelPinText1" rows="3" placeholder="–û—Å–Ω–æ–≤–Ω–∏–π —Ç–µ–∫—Å—Ç..."
                            style="width:100%;padding:0.65rem 0.9rem;border:2px solid var(--color-border);
                            border-radius:8px;font-family:'DM Sans',sans-serif;font-size:0.875rem;
                            background:var(--color-bg);color:var(--color-text);box-sizing:border-box;resize:vertical;"></textarea>
                    </div>
                    <div class="field" style="margin-top:0.75rem;">
                        <label style="font-size:0.8rem;font-weight:600;color:var(--color-text-secondary);">–¢–µ–∫—Å—Ç (–∞–±–∑–∞—Ü 2, –Ω–µ–æ–±–æ–≤'—è–∑–∫–æ–≤–æ)</label>
                        <textarea id="kostelPinText2" rows="3" placeholder="–î–æ–¥–∞—Ç–∫–æ–≤–∏–π —Ç–µ–∫—Å—Ç..."
                            style="width:100%;padding:0.65rem 0.9rem;border:2px solid var(--color-border);
                            border-radius:8px;font-family:'DM Sans',sans-serif;font-size:0.875rem;
                            background:var(--color-bg);color:var(--color-text);box-sizing:border-box;resize:vertical;"></textarea>
                    </div>
                    <div style="display:flex;gap:0.75rem;margin-top:1.25rem;">
                        <button id="kostelPinSaveBtn" class="btn btn-primary" style="flex:1;">‚úÖ –ó–±–µ—Ä–µ–≥—Ç–∏ –ø—ñ–Ω</button>
                        <button id="kostelPinCancelBtn" class="btn btn-outline" style="flex:1;">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                    </div>
                </div>
            </div>
        </div><!-- /kostelEditorCard -->

    </div><!-- /adminContent -->
</div>

<script>
(function(){
    var saved = localStorage.getItem("theme") || "light";
    document.documentElement.setAttribute("data-theme", saved);
    document.addEventListener("DOMContentLoaded", function() {
        var btn = document.getElementById("themeToggle");
        if (btn) btn.addEventListener("click", function() {
            var cur = document.documentElement.getAttribute("data-theme");
            var next = cur === "dark" ? "light" : "dark";
            document.documentElement.setAttribute("data-theme", next);
            localStorage.setItem("theme", next);
        });
    });
})();
</script>
<script>
// ===================================================================
// –ê–î–ú–Ü–ù –ü–ê–ù–ï–õ–¨ - –õ–û–ì–Ü–ö–ê v2.0 (—Ñ–æ—Ç–æ + –∫–Ω–∏–≥–∏ + –º–µ—Ç—Ä–∏—á–Ω—ñ –∫–Ω–∏–≥–∏)
// ===================================================================

const ADMIN_PASSWORD  = 'admin2026';
const GITHUB_REPO     = 'jerkinsmichael13-stack/Dubrovytsia1';
const PHOTOS_FILE     = 'photos.json';
const BOOKS_FILE      = 'books.json';
const METRICS_FILE    = 'metrics.json';
const BRANCH          = 'main';

const PERIOD_NAMES = {
    'before-1900': '–î–æ 1900',
    '1900-1939':   '1900‚Äî1939',
    '1939-1945':   '1939‚Äî1945',
    '1945-1991':   '1945‚Äî1991',
    'after-1991':  '–ü—ñ—Å–ª—è 1991'
};
const CATEGORY_NAMES = {
    churches:     'üõê –¶–µ—Ä–∫–≤–∏',
    streets:      'üèòÔ∏è –í—É–ª–∏—Ü—ñ',
    people:       'üë• –õ—é–¥–∏',
    architecture: 'üèõÔ∏è –ê—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞',
    aerial:       '‚úàÔ∏è –ê–µ—Ä–æ—Ñ–æ—Ç–æ',
    drawings:     'üé® –ú–∞–ª—é–Ω–∫–∏',
    events:       'üìÖ –ü–æ–¥—ñ—ó'
};

// Current active content type
let currentContentType = 'photo';

// ‚îÄ‚îÄ‚îÄ Utility ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getToken() { return localStorage.getItem('gh_token_dubrovytsia') || ''; }
function setToken(t) { localStorage.setItem('gh_token_dubrovytsia', t); }

function showStatus(id, msg, type='info') {
    const el = document.getElementById(id);
    if (!el) return;
    el.className = `notice notice-${type}`;
    el.innerHTML = msg;
    el.style.display = 'block';
    el.scrollIntoView({ behavior:'smooth', block:'nearest' });
}

// ‚îÄ‚îÄ‚îÄ GitHub API ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function ghGet(path) {
    const r = await fetch(`https://api.github.com/repos/${GITHUB_REPO}/contents/${path}`, {
        headers: { Authorization: `token ${getToken()}`, Accept: 'application/vnd.github.v3+json' }
    });
    if (!r.ok) throw new Error(`GitHub API: ${r.status} ${r.statusText}`);
    return r.json();
}

async function ghPut(path, content, sha, message) {
    const body = { message, content: btoa(unescape(encodeURIComponent(content))), branch: BRANCH };
    if (sha) body.sha = sha;
    const r = await fetch(`https://api.github.com/repos/${GITHUB_REPO}/contents/${path}`, {
        method: 'PUT',
        headers: {
            Authorization: `token ${getToken()}`,
            Accept: 'application/vnd.github.v3+json',
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(body)
    });
    if (!r.ok) {
        const err = await r.json().catch(()=>({}));
        throw new Error(err.message || `GitHub API: ${r.status}`);
    }
    return r.json();
}

async function loadJsonFromGH(filename) {
    try {
        const data = await ghGet(filename);
        const json = decodeURIComponent(escape(atob(data.content.replace(/\n/g,''))));
        return { items: JSON.parse(json), sha: data.sha };
    } catch(e) {
        // File might not exist yet ‚Äî return empty
        if (e.message.includes('404')) return { items: [], sha: null };
        throw e;
    }
}

// ‚îÄ‚îÄ‚îÄ Login ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.addEventListener('DOMContentLoaded', function() {

document.getElementById('loginBtn').addEventListener('click', () => {
    const pw = document.getElementById('loginPassword').value;
    if (pw === ADMIN_PASSWORD) {
        document.getElementById('loginCard').style.display = 'none';
        document.getElementById('adminContent').style.display = 'block';
        document.getElementById('loginError').style.display = 'none';
        initAdmin();
    } else {
        document.getElementById('loginError').style.display = 'block';
        document.getElementById('loginPassword').value = '';
    }
});
document.getElementById('loginPassword').addEventListener('keydown', e => {
    if (e.key === 'Enter') document.getElementById('loginBtn').click();
});

// ‚îÄ‚îÄ‚îÄ Init Admin ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function initAdmin() {
    // Token section
    const tok = getToken();
    if (tok) {
        document.getElementById('tokenSetupSection').style.display = 'none';
        document.getElementById('tokenOkSection').style.display = 'block';
    }

    document.getElementById('saveTokenBtn').addEventListener('click', () => {
        const t = document.getElementById('githubToken').value.trim();
        if (!t.startsWith('ghp_') && !t.startsWith('github_pat_')) {
            alert('‚ùå –¢–æ–∫–µ–Ω –º–∞—î –ø–æ—á–∏–Ω–∞—Ç–∏—Å—è –∑ ghp_ –∞–±–æ github_pat_');
            return;
        }
        setToken(t);
        document.getElementById('tokenSetupSection').style.display = 'none';
        document.getElementById('tokenOkSection').style.display = 'block';
    });

    document.getElementById('changeTokenBtn').addEventListener('click', () => {
        document.getElementById('tokenSetupSection').style.display = 'block';
        document.getElementById('tokenOkSection').style.display = 'none';
    });

    document.getElementById('toggleToken').addEventListener('click', function() {
        const inp = document.getElementById('githubToken');
        if (inp.type === 'password') { inp.type = 'text'; this.textContent = '–ü—Ä–∏—Ö–æ–≤–∞—Ç–∏'; }
        else { inp.type = 'password'; this.textContent = '–ü–æ–∫–∞–∑–∞—Ç–∏'; }
    });

    // ‚îÄ‚îÄ Content type switcher ‚îÄ‚îÄ
    document.querySelectorAll('.content-type-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            currentContentType = this.dataset.type;
            // Update button styles
            document.querySelectorAll('.content-type-btn').forEach(b => {
                b.style.background = 'transparent';
                b.style.color = 'var(--color-text)';
                b.style.borderColor = 'var(--color-border)';
            });
            this.style.background = 'var(--color-primary)';
            this.style.color = 'white';
            this.style.borderColor = 'var(--color-primary)';
            // Show correct form
            document.querySelectorAll('.content-form').forEach(f => f.style.display = 'none');
            const form = document.getElementById('form-' + currentContentType);
            if (form) form.style.display = 'block';
            // Reset to add tab
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
            document.querySelector('[data-tab="add"]').classList.add('active');
            document.getElementById('tab-add').classList.add('active');
        });
    });

    // ‚îÄ‚îÄ Tabs ‚îÄ‚îÄ
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
            this.classList.add('active');
            const panel = document.getElementById('tab-' + this.dataset.tab);
            if (panel) panel.classList.add('active');
            if (this.dataset.tab === 'list') renderList();
        });
    });

    // ‚îÄ‚îÄ Preview photo URL ‚îÄ‚îÄ
    const urlInput = document.getElementById('newPhotoUrl');
    const preview  = document.getElementById('photoPreview');
    let previewTimer;
    if (urlInput) {
        urlInput.addEventListener('input', () => {
            clearTimeout(previewTimer);
            previewTimer = setTimeout(() => {
                const v = urlInput.value.trim();
                if (v.startsWith('http')) {
                    preview.src = v;
                    preview.style.display = 'block';
                    preview.onerror = () => { preview.style.display = 'none'; };
                } else {
                    preview.style.display = 'none';
                }
            }, 500);
        });
    }

    // ‚îÄ‚îÄ Publish buttons ‚îÄ‚îÄ
    document.getElementById('publishPhotoBtn').addEventListener('click', publishPhoto);
    document.getElementById('publishBookBtn').addEventListener('click', publishBook);
    document.getElementById('publishMetricBtn').addEventListener('click', publishMetric);
    document.getElementById('publishPinBtn').addEventListener('click', publishPin);
}

// ‚îÄ‚îÄ‚îÄ Publish Photo ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function publishPhoto() {
    const url         = document.getElementById('newPhotoUrl').value.trim();
    const originalUrl = document.getElementById('newPhotoOriginalUrl').value.trim();
    const title       = document.getElementById('newPhotoTitle').value.trim();
    const period      = document.getElementById('newPhotoPeriod').value;
    const category    = document.getElementById('newPhotoCategory').value;
    const date        = document.getElementById('newPhotoDate').value.trim();

    if (!url || !title || !period || !category) {
        showStatus('statusMsgPhoto', '‚ùå –ë—É–¥—å –ª–∞—Å–∫–∞, –∑–∞–ø–æ–≤–Ω—ñ—Ç—å —É—Å—ñ –æ–±–æ–≤\'—è–∑–∫–æ–≤—ñ –ø–æ–ª—è (*)', 'error');
        return;
    }
    if (!url.startsWith('http')) {
        showStatus('statusMsgPhoto', '‚ùå URL —Ñ–æ—Ç–æ –º–∞—î –ø–æ—á–∏–Ω–∞—Ç–∏—Å—è –∑ https://', 'error');
        return;
    }
    if (!getToken()) {
        showStatus('statusMsgPhoto', '‚ùå –°–ø–æ—á–∞—Ç–∫—É –∑–±–µ—Ä–µ–∂—ñ—Ç—å GitHub Token –≤–∏—â–µ', 'error');
        return;
    }

    const btn = document.getElementById('publishPhotoBtn');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-sm"></span> –ü—É–±–ª—ñ–∫–∞—Ü—ñ—è...';
    showStatus('statusMsgPhoto', '‚è≥ –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ GitHub...', 'info');

    try {
        showStatus('statusMsgPhoto', '‚è≥ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø–æ—Ç–æ—á–Ω–æ–≥–æ –∞—Ä—Ö—ñ–≤—É...', 'info');
        const { items: photos, sha } = await loadJsonFromGH(PHOTOS_FILE);

        const newPhoto = { imageUrl: url, title, period, category, date: date || new Date().getFullYear().toString() };
        if (originalUrl) newPhoto.originalUrl = originalUrl;
        photos.unshift(newPhoto);

        showStatus('statusMsgPhoto', '‚è≥ –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –≤ GitHub...', 'info');
        await ghPut(PHOTOS_FILE, JSON.stringify(photos, null, 4), sha, `–î–æ–¥–∞–Ω–æ —Ñ–æ—Ç–æ: ${title}`);

        showStatus('statusMsgPhoto', `‚úÖ –§–æ—Ç–æ "<strong>${title}</strong>" —É—Å–ø—ñ—à–Ω–æ –æ–ø—É–±–ª—ñ–∫–æ–≤–∞–Ω–æ! –ß–µ—Ä–µ–∑ 1-3 —Ö–≤–∏–ª–∏–Ω–∏ –∑'—è–≤–∏—Ç—å—Å—è –Ω–∞ —Å–∞–π—Ç—ñ.`, 'success');

        document.getElementById('newPhotoUrl').value = '';
        document.getElementById('newPhotoOriginalUrl').value = '';
        document.getElementById('newPhotoTitle').value = '';
        document.getElementById('newPhotoPeriod').value = '';
        document.getElementById('newPhotoCategory').value = '';
        document.getElementById('newPhotoDate').value = '';
        document.getElementById('photoPreview').style.display = 'none';

    } catch (err) {
        let msg = err.message;
        if (msg.includes('401') || msg.includes('Bad credentials')) msg = '–ù–µ–≤—ñ—Ä–Ω–∏–π GitHub Token.';
        else if (msg.includes('404')) msg = '–§–∞–π–ª photos.json –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—ó.';
        showStatus('statusMsgPhoto', `‚ùå –ü–æ–º–∏–ª–∫–∞: ${msg}`, 'error');
    } finally {
        btn.disabled = false;
        btn.innerHTML = 'üöÄ –û–ø—É–±–ª—ñ–∫—É–≤–∞—Ç–∏ —Ñ–æ—Ç–æ';
    }
}

// ‚îÄ‚îÄ‚îÄ Publish Book ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function publishBook() {
    const title       = document.getElementById('newBookTitle').value.trim();
    const author      = document.getElementById('newBookAuthor').value.trim();
    const year        = document.getElementById('newBookYear').value.trim();
    const category    = document.getElementById('newBookCategory').value;
    const location    = document.getElementById('newBookLocation').value.trim();
    const description = document.getElementById('newBookDescription').value.trim();
    const coverUrl    = document.getElementById('newBookCoverUrl').value.trim();
    const downloadUrl = document.getElementById('newBookDownloadUrl').value.trim();

    if (!title || !author || !description) {
        showStatus('statusMsgBook', '‚ùå –ó–∞–ø–æ–≤–Ω—ñ—Ç—å –æ–±–æ–≤\'—è–∑–∫–æ–≤—ñ –ø–æ–ª—è: –Ω–∞–∑–≤–∞, –∞–≤—Ç–æ—Ä, –æ–ø–∏—Å', 'error');
        return;
    }
    if (!getToken()) {
        showStatus('statusMsgBook', '‚ùå –°–ø–æ—á–∞—Ç–∫—É –∑–±–µ—Ä–µ–∂—ñ—Ç—å GitHub Token –≤–∏—â–µ', 'error');
        return;
    }

    const btn = document.getElementById('publishBookBtn');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-sm"></span> –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è...';
    showStatus('statusMsgBook', '‚è≥ –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ GitHub...', 'info');

    try {
        const { items: books, sha } = await loadJsonFromGH(BOOKS_FILE);

        const newBook = { title, author, year, category, location, description };
        if (coverUrl) newBook.coverUrl = coverUrl;
        if (downloadUrl) newBook.downloadUrl = downloadUrl;
        books.unshift(newBook);

        await ghPut(BOOKS_FILE, JSON.stringify(books, null, 4), sha, `–î–æ–¥–∞–Ω–æ –∫–Ω–∏–≥—É: ${title}`);

        showStatus('statusMsgBook', `‚úÖ –ö–Ω–∏–≥–∞ "<strong>${title}</strong>" —É—Å–ø—ñ—à–Ω–æ –¥–æ–¥–∞–Ω–∞ –¥–æ –∫–∞—Ç–∞–ª–æ–≥—É!`, 'success');

        document.getElementById('newBookTitle').value = '';
        document.getElementById('newBookAuthor').value = '';
        document.getElementById('newBookYear').value = '';
        document.getElementById('newBookLocation').value = '';
        document.getElementById('newBookDescription').value = '';
        document.getElementById('newBookCoverUrl').value = '';
        document.getElementById('newBookDownloadUrl').value = '';

    } catch (err) {
        showStatus('statusMsgBook', `‚ùå –ü–æ–º–∏–ª–∫–∞: ${err.message}`, 'error');
    } finally {
        btn.disabled = false;
        btn.innerHTML = 'üìö –î–æ–¥–∞—Ç–∏ –∫–Ω–∏–≥—É –¥–æ –∫–∞—Ç–∞–ª–æ–≥—É';
    }
}

// ‚îÄ‚îÄ‚îÄ Publish Metric Book ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function publishMetric() {
    const parish     = document.getElementById('newMetricParish').value.trim();
    const years      = document.getElementById('newMetricYears').value.trim();
    const confession = document.getElementById('newMetricConfession').value;
    const villages   = document.getElementById('newMetricVillages').value.trim();
    const archive    = document.getElementById('newMetricArchive').value.trim();
    const scanUrl    = document.getElementById('newMetricScanUrl').value.trim();

    // Collect checked record types
    const types = [];
    if (document.getElementById('metricBirth').checked) types.push('–ù–∞—Ä–æ–¥–∂–µ–Ω–Ω—è');
    if (document.getElementById('metricMarriage').checked) types.push('–®–ª—é–±–∏');
    if (document.getElementById('metricDeath').checked) types.push('–°–º–µ—Ä—Ç—ñ');
    if (document.getElementById('metricConfessionRec').checked) types.push('–°–ø–æ–≤—ñ–¥–Ω—ñ –∑–∞–ø–∏—Å–∏');

    if (!parish || !years || !confession) {
        showStatus('statusMsgMetric', '‚ùå –ó–∞–ø–æ–≤–Ω—ñ—Ç—å –æ–±–æ–≤\'—è–∑–∫–æ–≤—ñ –ø–æ–ª—è: –ø–∞—Ä–∞—Ñ—ñ—è, —Ä–æ–∫–∏, –∫–æ–Ω—Ñ–µ—Å—ñ—è', 'error');
        return;
    }
    if (!getToken()) {
        showStatus('statusMsgMetric', '‚ùå –°–ø–æ—á–∞—Ç–∫—É –∑–±–µ—Ä–µ–∂—ñ—Ç—å GitHub Token –≤–∏—â–µ', 'error');
        return;
    }

    const btn = document.getElementById('publishMetricBtn');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-sm"></span> –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è...';
    showStatus('statusMsgMetric', '‚è≥ –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ GitHub...', 'info');

    try {
        const { items: metrics, sha } = await loadJsonFromGH(METRICS_FILE);

        const newMetric = {
            parish, years, confession,
            recordTypes: types.length ? types.join(', ') : '–ù–∞—Ä–æ–¥–∂–µ–Ω–Ω—è, —à–ª—é–±–∏, —Å–º–µ—Ä—Ç—ñ',
            villages, archive
        };
        if (scanUrl) newMetric.scanUrl = scanUrl;
        metrics.unshift(newMetric);

        await ghPut(METRICS_FILE, JSON.stringify(metrics, null, 4), sha, `–î–æ–¥–∞–Ω–æ –º–µ—Ç—Ä–∏—á–Ω—É –∫–Ω–∏–≥—É: ${parish}`);

        showStatus('statusMsgMetric', `‚úÖ –ú–µ—Ç—Ä–∏—á–Ω–∞ –∫–Ω–∏–≥–∞ "<strong>${parish}</strong>" —É—Å–ø—ñ—à–Ω–æ –¥–æ–¥–∞–Ω–∞!`, 'success');

        document.getElementById('newMetricParish').value = '';
        document.getElementById('newMetricYears').value = '';
        document.getElementById('newMetricConfession').value = '';
        document.getElementById('newMetricVillages').value = '';
        document.getElementById('newMetricArchive').value = '';
        document.getElementById('newMetricScanUrl').value = '';
        document.getElementById('metricBirth').checked = false;
        document.getElementById('metricMarriage').checked = false;
        document.getElementById('metricDeath').checked = false;

    } catch (err) {
        showStatus('statusMsgMetric', `‚ùå –ü–æ–º–∏–ª–∫–∞: ${err.message}`, 'error');
    } finally {
        btn.disabled = false;
        btn.innerHTML = 'üìñ –î–æ–¥–∞—Ç–∏ –º–µ—Ç—Ä–∏—á–Ω—É –∫–Ω–∏–≥—É';
    }
}

// ‚îÄ‚îÄ‚îÄ Publish Kostel Pin ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function publishPin() {
    const x         = parseFloat(document.getElementById('newPinX').value);
    const y         = parseFloat(document.getElementById('newPinY').value);
    const side      = document.getElementById('newPinSide').value;
    const label     = document.getElementById('newPinLabel').value.trim();
    const cardTitle = document.getElementById('newPinCardTitle').value.trim();
    const text1     = document.getElementById('newPinText1').value.trim();
    const text2     = document.getElementById('newPinText2').value.trim();

    if (isNaN(x) || isNaN(y) || !cardTitle || !text1) {
        showStatus('statusMsgPin', '‚ùå –ó–∞–ø–æ–≤–Ω—ñ—Ç—å –æ–±–æ–≤\'—è–∑–∫–æ–≤—ñ –ø–æ–ª—è: –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ X, Y, –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Ç–∞ —Ç–µ–∫—Å—Ç', 'error');
        return;
    }
    if (!getToken()) {
        showStatus('statusMsgPin', '‚ùå –°–ø–æ—á–∞—Ç–∫—É –∑–±–µ—Ä–µ–∂—ñ—Ç—å GitHub Token –≤–∏—â–µ', 'error');
        return;
    }

    const btn = document.getElementById('publishPinBtn');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-sm"></span> –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è...';
    showStatus('statusMsgPin', '‚è≥ –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ GitHub...', 'info');

    try {
        const { items: pins, sha } = await loadJsonFromGH('kostel_pins.json');
        const newId = pins.length > 0 ? Math.max(...pins.map(p => p.id || 0)) + 1 : 1;
        const newPin = { id: newId, x, y, side, label, cardTitle, text1 };
        if (text2) newPin.text2 = text2;
        pins.push(newPin);

        await ghPut('kostel_pins.json', JSON.stringify(pins, null, 2), sha, `–î–æ–¥–∞–Ω–æ –ø—ñ–Ω: ${cardTitle}`);
        showStatus('statusMsgPin', `‚úÖ –ü—ñ–Ω "<strong>${cardTitle}</strong>" –¥–æ–¥–∞–Ω–æ! –í—ñ–¥–æ–±—Ä–∞–∑–∏—Ç—å—Å—è –Ω–∞ —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ –ü–∞–º'—è—Ç–æ–∫ —á–µ—Ä–µ–∑ 1‚Äì3 —Ö–≤.`, 'success');

        document.getElementById('newPinX').value = '';
        document.getElementById('newPinY').value = '';
        document.getElementById('newPinLabel').value = '';
        document.getElementById('newPinCardTitle').value = '';
        document.getElementById('newPinText1').value = '';
        document.getElementById('newPinText2').value = '';
    } catch (err) {
        showStatus('statusMsgPin', `‚ùå –ü–æ–º–∏–ª–∫–∞: ${err.message}`, 'error');
    } finally {
        btn.disabled = false;
        btn.innerHTML = 'üìç –î–æ–¥–∞—Ç–∏ –ø—ñ–Ω';
    }
}
async function renderList() {
    const wrap = document.getElementById('photoListWrap');

    wrap.innerHTML = '<p style="color:var(--color-text-secondary);">‚è≥ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</p>';

    try {
        if (currentContentType === 'photo') {
            await renderPhotoList(wrap);
        } else if (currentContentType === 'book') {
            await renderBookList(wrap);
        } else if (currentContentType === 'metric') {
            await renderMetricList(wrap);
        } else if (currentContentType === 'pin') {
            await renderPinList(wrap);
        }
    } catch(e) {
        let msg = e.message;
        if (msg.includes('401')) msg = '–ù–µ–≤—ñ—Ä–Ω–∏–π GitHub Token.';
        wrap.innerHTML = `<div class="notice notice-error">‚ùå ${msg}</div>`;
    }
}


// ‚îÄ‚îÄ‚îÄ HTML-escape helper ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function esc(s) {
    return String(s||'')
        .replace(/&/g,'&amp;')
        .replace(/"/g,'&quot;')
        .replace(/</g,'&lt;')
        .replace(/>/g,'&gt;');
}

// ‚îÄ‚îÄ‚îÄ Edit Modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openEditModal(fieldsHtml, onSave) {
    document.getElementById('editModal')?.remove();
    const m = document.createElement('div');
    m.id = 'editModal';
    m.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.78);backdrop-filter:blur(10px);z-index:9999;display:flex;align-items:center;justify-content:center;padding:1rem;';
    m.innerHTML = `
        <div style="background:var(--color-surface);border:1px solid var(--color-border);border-radius:1.25rem;padding:2rem;width:100%;max-width:620px;max-height:92vh;overflow-y:auto;box-shadow:0 40px 100px rgba(0,0,0,0.55);">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem;">
                <h3 style="font-family:'Cormorant Garamond',serif;font-size:1.6rem;font-weight:500;color:var(--color-text);margin:0;">‚úèÔ∏è –†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è</h3>
                <button id="em_close" style="width:36px;height:36px;border-radius:50%;border:1px solid var(--color-border);background:var(--color-bg);color:var(--color-text);font-size:1.2rem;cursor:pointer;display:flex;align-items:center;justify-content:center;">√ó</button>
            </div>
            <div id="em_body">${fieldsHtml}</div>
            <div id="em_status" class="notice" style="display:none;margin-top:1rem;"></div>
            <div style="display:flex;gap:0.75rem;justify-content:flex-end;margin-top:1.5rem;">
                <button id="em_cancel" class="btn btn-outline">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                <button id="em_save" class="btn btn-green">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏ –∑–º—ñ–Ω–∏</button>
            </div>
        </div>`;
    document.body.appendChild(m);

    const close = () => m.remove();
    document.getElementById('em_close').onclick = close;
    document.getElementById('em_cancel').onclick = close;
    m.addEventListener('click', e => { if (e.target === m) close(); });

    document.getElementById('em_save').addEventListener('click', async () => {
        const saveBtn = document.getElementById('em_save');
        const statusEl = document.getElementById('em_status');
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<span class="spinner-sm"></span> –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è...';
        try {
            await onSave();
            m.remove();
            renderList();
        } catch(err) {
            statusEl.className = 'notice notice-error';
            statusEl.textContent = '‚ùå ' + err.message;
            statusEl.style.display = 'block';
            saveBtn.disabled = false;
            saveBtn.innerHTML = 'üíæ –ó–±–µ—Ä–µ–≥—Ç–∏ –∑–º—ñ–Ω–∏';
        }
    });
}

// ‚îÄ‚îÄ‚îÄ Render Photo List ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function renderPhotoList(wrap) {
    // Use public raw URL - no token needed for reading
    const rawUrl = `https://raw.githubusercontent.com/${GITHUB_REPO}/main/${PHOTOS_FILE}?v=${Date.now()}`;
    const rawResp = await fetch(rawUrl);
    const photos = rawResp.ok ? await rawResp.json() : [];
    if (!photos.length) { wrap.innerHTML = '<p style="color:var(--color-text-secondary);">–§–æ—Ç–æ–≥—Ä–∞—Ñ—ñ–π —â–µ –Ω–µ–º–∞—î</p>'; return; }

    wrap.innerHTML = `<p style="color:var(--color-text-secondary);margin-bottom:1rem;">–í—Å—å–æ–≥–æ: <strong>${photos.length}</strong> —Ñ–æ—Ç–æ</p><div class="photo-list" id="pList"></div>`;
    const list = document.getElementById('pList');

    photos.forEach((p, i) => {
        const d = document.createElement('div');
        d.className = 'photo-item';
        d.innerHTML = `
            <img src="${esc(p.imageUrl)}" style="width:72px;height:52px;object-fit:cover;border-radius:0.5rem;flex-shrink:0;" onerror="this.style.opacity=0">
            <div class="photo-item-info" style="flex:1;min-width:0;">
                <h4 style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${esc(p.title)}</h4>
                <p>
                    <span class="badge">${PERIOD_NAMES[p.period]||p.period}</span>
                    <span class="badge" style="background:#5d4037;">${CATEGORY_NAMES[p.category]||p.category}</span>
                    ${p.date?`<span style="font-size:.75rem;color:var(--color-text-secondary);">${esc(p.date)}</span>`:''}
                    ${p.originalUrl?`<span style="font-size:.75rem;color:#2196f3;">üì• –æ—Ä–∏–≥—ñ–Ω–∞–ª</span>`:''}
                </p>
            </div>
            <div style="display:flex;gap:.4rem;flex-shrink:0;">
                <button class="btn ep-edit" data-i="${i}" style="padding:.45rem .7rem;font-size:.8rem;background:var(--color-bg);border:1px solid var(--color-border);color:var(--color-text);border-radius:.5rem;">‚úèÔ∏è</button>
                <button class="btn btn-red ep-del" data-i="${i}" style="padding:.45rem .7rem;font-size:.8rem;">üóë</button>
            </div>`;
        list.appendChild(d);
    });

    list.querySelectorAll('.ep-edit').forEach(btn => btn.addEventListener('click', () => {
        const i = +btn.dataset.i, p = photos[i];
        openEditModal(`
            <div class="field"><label>–ù–∞–∑–≤–∞ *</label><input id="ef_title" type="text" value="${esc(p.title)}"></div>
            <div class="field"><label>URL —Ñ–æ—Ç–æ *</label><input id="ef_url" type="url" value="${esc(p.imageUrl)}"></div>
            <div class="field">
                <label>–ü–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ –æ—Ä–∏–≥—ñ–Ω–∞–ª (Google Drive)</label>
                <input id="ef_orig" type="url" value="${esc(p.originalUrl||'')}" placeholder="https://drive.google.com/file/d/...">
                <div style="font-size:.78rem;color:var(--color-text-secondary);margin-top:.3rem;">–ü—Ä—è–º–µ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ Google Drive ‚Äî –±—É–¥–µ –ø–æ–∫–∞–∑–∞–Ω–æ —è–∫ –∫–Ω–æ–ø–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —É —Ñ–æ—Ç–æ–∞—Ä—Ö—ñ–≤—ñ</div>
            </div>
            <div class="grid-2">
                <div class="field"><label>–ü–µ—Ä—ñ–æ–¥</label><select id="ef_period">
                    <option value="before-1900" ${p.period==='before-1900'?'selected':''}>–î–æ 1900</option>
                    <option value="1900-1939" ${p.period==='1900-1939'?'selected':''}>1900‚Äî1939</option>
                    <option value="1939-1945" ${p.period==='1939-1945'?'selected':''}>1939‚Äî1945</option>
                    <option value="1945-1991" ${p.period==='1945-1991'?'selected':''}>1945‚Äî1991</option>
                    <option value="after-1991" ${p.period==='after-1991'?'selected':''}>–ü—ñ—Å–ª—è 1991</option>
                </select></div>
                <div class="field"><label>–ö–∞—Ç–µ–≥–æ—Ä—ñ—è</label><select id="ef_cat">
                    <option value="churches" ${p.category==='churches'?'selected':''}>üõê –¶–µ—Ä–∫–≤–∏</option>
                    <option value="streets" ${p.category==='streets'?'selected':''}>üèòÔ∏è –í—É–ª–∏—Ü—ñ</option>
                    <option value="people" ${p.category==='people'?'selected':''}>üë• –õ—é–¥–∏</option>
                    <option value="architecture" ${p.category==='architecture'?'selected':''}>üèõÔ∏è –ê—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞</option>
                    <option value="aerial" ${p.category==='aerial'?'selected':''}>‚úàÔ∏è –ê–µ—Ä–æ—Ñ–æ—Ç–æ</option>
                    <option value="drawings" ${p.category==='drawings'?'selected':''}>üé® –ú–∞–ª—é–Ω–∫–∏</option>
                    <option value="events" ${p.category==='events'?'selected':''}>üìÖ –ü–æ–¥—ñ—ó</option>
                </select></div>
            </div>
            <div class="field"><label>–†—ñ–∫</label><input id="ef_date" type="text" value="${esc(p.date||'')}"></div>
        `, async () => {
            const title = document.getElementById('ef_title').value.trim();
            const url   = document.getElementById('ef_url').value.trim();
            if (!title || !url) throw new Error('–ù–∞–∑–≤–∞ —Ç–∞ URL –æ–±–æ–≤\'—è–∑–∫–æ–≤—ñ');
            const orig = document.getElementById('ef_orig').value.trim();
            const { items, sha } = await loadJsonFromGH(PHOTOS_FILE);
            items[i] = { imageUrl: url, title, period: document.getElementById('ef_period').value, category: document.getElementById('ef_cat').value, date: document.getElementById('ef_date').value.trim() };
            if (orig) items[i].originalUrl = orig;
            await ghPut(PHOTOS_FILE, JSON.stringify(items, null, 4), sha, `–†–µ–¥–∞–≥–æ–≤–∞–Ω–æ: ${title}`);
        });
    }));

    list.querySelectorAll('.ep-del').forEach(btn => btn.addEventListener('click', async () => {
        const i = +btn.dataset.i;
        if (!confirm(`–í–∏–¥–∞–ª–∏—Ç–∏ "${photos[i].title}"?`)) return;
        btn.disabled = true; btn.textContent = '...';
        try {
            const { items, sha } = await loadJsonFromGH(PHOTOS_FILE);
            await ghPut(PHOTOS_FILE, JSON.stringify(items.filter((_,j) => j !== i), null, 4), sha, `–í–∏–¥–∞–ª–µ–Ω–æ: ${photos[i].title}`);
            renderList();
        } catch(e) { alert('‚ùå '+e.message); btn.disabled=false; btn.textContent='üóë'; }
    }));
}

// ‚îÄ‚îÄ‚îÄ Render Book List ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function renderBookList(wrap) {
    const { items: books } = await loadJsonFromGH(BOOKS_FILE);
    if (!books.length) { wrap.innerHTML = '<p style="color:var(--color-text-secondary);">–ö–Ω–∏–≥ —â–µ –Ω–µ–º–∞—î</p>'; return; }

    wrap.innerHTML = `<p style="color:var(--color-text-secondary);margin-bottom:1rem;">–í—Å—å–æ–≥–æ: <strong>${books.length}</strong> –∫–Ω–∏–≥</p><div class="photo-list" id="bList"></div>`;
    const list = document.getElementById('bList');

    books.forEach((b, i) => {
        const d = document.createElement('div');
        d.className = 'photo-item';
        d.innerHTML = `
            <div style="width:72px;height:52px;background:var(--color-bg);border-radius:.5rem;display:flex;align-items:center;justify-content:center;font-size:1.5rem;flex-shrink:0;">üìö</div>
            <div class="photo-item-info" style="flex:1;min-width:0;">
                <h4 style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${esc(b.title)}</h4>
                <p style="color:var(--color-text-secondary);font-size:.8rem;">${esc(b.author||'')}${b.year?' ¬∑ '+esc(b.year):''}${b.downloadUrl?' ¬∑ <span style="color:#2196f3;">üì• –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è</span>':''}</p>
            </div>
            <div style="display:flex;gap:.4rem;flex-shrink:0;">
                <button class="btn eb-edit" data-i="${i}" style="padding:.45rem .7rem;font-size:.8rem;background:var(--color-bg);border:1px solid var(--color-border);color:var(--color-text);border-radius:.5rem;">‚úèÔ∏è</button>
                <button class="btn btn-red eb-del" data-i="${i}" style="padding:.45rem .7rem;font-size:.8rem;">üóë</button>
            </div>`;
        list.appendChild(d);
    });

    list.querySelectorAll('.eb-edit').forEach(btn => btn.addEventListener('click', () => {
        const i = +btn.dataset.i, b = books[i];
        openEditModal(`
            <div class="grid-2">
                <div class="field"><label>–ù–∞–∑–≤–∞ *</label><input id="ef_btitle" type="text" value="${esc(b.title)}"></div>
                <div class="field"><label>–ê–≤—Ç–æ—Ä</label><input id="ef_bauthor" type="text" value="${esc(b.author||'')}"></div>
            </div>
            <div class="grid-2">
                <div class="field"><label>–†—ñ–∫</label><input id="ef_byear" type="text" value="${esc(b.year||'')}"></div>
                <div class="field"><label>–ö–∞—Ç–µ–≥–æ—Ä—ñ—è</label><select id="ef_bcat">
                    <option value="history" ${b.category==='history'?'selected':''}>–Ü—Å—Ç–æ—Ä—ñ—è</option>
                    <option value="culture" ${b.category==='culture'?'selected':''}>–ö—É–ª—å—Ç—É—Ä–∞ —Ç–∞ —Å–ø–∞–¥—â–∏–Ω–∞</option>
                    <option value="war" ${b.category==='war'?'selected':''}>–î—Ä—É–≥–∞ —Å–≤—ñ—Ç–æ–≤–∞</option>
                    <option value="religion" ${b.category==='religion'?'selected':''}>–†–µ–ª—ñ–≥—ñ—è —Ç–∞ —Ü–µ—Ä–∫–≤–∏</option>
                    <option value="people" ${b.category==='people'?'selected':''}>–í–∏–¥–∞—Ç–Ω—ñ –ø–æ—Å—Ç–∞—Ç—ñ</option>
                    <option value="documents" ${b.category==='documents'?'selected':''}>–î–æ–∫—É–º–µ–Ω—Ç–∏ —Ç–∞ –∞—Ä—Ö—ñ–≤–∏</option>
                    <option value="folklore" ${b.category==='folklore'?'selected':''}>–§–æ–ª—å–∫–ª–æ—Ä —Ç–∞ –ª–µ–≥–µ–Ω–¥–∏</option>
                </select></div>
            </div>
            <div class="field"><label>–ú—ñ—Å—Ü–µ –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è</label><input id="ef_bloc" type="text" value="${esc(b.location||'')}"></div>
            <div class="field"><label>–û–ø–∏—Å</label><textarea id="ef_bdesc" rows="4">${esc(b.description||'')}</textarea></div>
            <div class="field"><label>–û–±–∫–ª–∞–¥–∏–Ω–∫–∞ (URL)</label><input id="ef_bcover" type="url" value="${esc(b.coverUrl||'')}"></div>
            <div class="field">
                <label>–ü–æ—Å–∏–ª–∞–Ω–Ω—è –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è (Google Drive / PDF)</label>
                <input id="ef_bdl" type="url" value="${esc(b.downloadUrl||'')}" placeholder="https://drive.google.com/file/d/...">
            </div>
        `, async () => {
            const title = document.getElementById('ef_btitle').value.trim();
            if (!title) throw new Error('–ù–∞–∑–≤–∞ –æ–±–æ–≤\'—è–∑–∫–æ–≤–∞');
            const { items, sha } = await loadJsonFromGH(BOOKS_FILE);
            const upd = { title, author: document.getElementById('ef_bauthor').value.trim(), year: document.getElementById('ef_byear').value.trim(), category: document.getElementById('ef_bcat').value, location: document.getElementById('ef_bloc').value.trim(), description: document.getElementById('ef_bdesc').value.trim() };
            const cv = document.getElementById('ef_bcover').value.trim();
            const dl = document.getElementById('ef_bdl').value.trim();
            if (cv) upd.coverUrl = cv;
            if (dl) upd.downloadUrl = dl;
            items[i] = upd;
            await ghPut(BOOKS_FILE, JSON.stringify(items, null, 4), sha, `–†–µ–¥–∞–≥–æ–≤–∞–Ω–æ –∫–Ω–∏–≥—É: ${title}`);
        });
    }));

    list.querySelectorAll('.eb-del').forEach(btn => btn.addEventListener('click', async () => {
        const i = +btn.dataset.i;
        if (!confirm(`–í–∏–¥–∞–ª–∏—Ç–∏ –∫–Ω–∏–≥—É "${books[i].title}"?`)) return;
        btn.disabled=true; btn.textContent='...';
        try {
            const { items, sha } = await loadJsonFromGH(BOOKS_FILE);
            await ghPut(BOOKS_FILE, JSON.stringify(items.filter((_,j)=>j!==i), null, 4), sha, `–í–∏–¥–∞–ª–µ–Ω–æ –∫–Ω–∏–≥—É: ${books[i].title}`);
            renderList();
        } catch(e) { alert('‚ùå '+e.message); btn.disabled=false; btn.textContent='üóë'; }
    }));
}

// ‚îÄ‚îÄ‚îÄ Render Metric List ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function renderMetricList(wrap) {
    const { items: metrics } = await loadJsonFromGH(METRICS_FILE);
    if (!metrics.length) { wrap.innerHTML = '<p style="color:var(--color-text-secondary);">–ú–µ—Ç—Ä–∏—á–Ω–∏—Ö –∫–Ω–∏–≥ —â–µ –Ω–µ–º–∞—î</p>'; return; }

    wrap.innerHTML = `<p style="color:var(--color-text-secondary);margin-bottom:1rem;">–í—Å—å–æ–≥–æ: <strong>${metrics.length}</strong> –∑–∞–ø–∏—Å—ñ–≤</p><div class="photo-list" id="mList"></div>`;
    const list = document.getElementById('mList');

    metrics.forEach((m, i) => {
        const d = document.createElement('div');
        d.className = 'photo-item';
        d.innerHTML = `
            <div style="width:72px;height:52px;background:var(--color-bg);border-radius:.5rem;display:flex;align-items:center;justify-content:center;font-size:1.5rem;flex-shrink:0;">üìñ</div>
            <div class="photo-item-info" style="flex:1;min-width:0;">
                <h4 style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${esc(m.parish)}</h4>
                <p style="color:var(--color-text-secondary);font-size:.8rem;">${esc(m.years)} ¬∑ ${esc(m.confession)}${m.scanUrl?' ¬∑ <span style="color:#2196f3;">üì• —Å–∫–∞–Ω</span>':''}</p>
            </div>
            <div style="display:flex;gap:.4rem;flex-shrink:0;">
                <button class="btn em-edit" data-i="${i}" style="padding:.45rem .7rem;font-size:.8rem;background:var(--color-bg);border:1px solid var(--color-border);color:var(--color-text);border-radius:.5rem;">‚úèÔ∏è</button>
                <button class="btn btn-red em-del" data-i="${i}" style="padding:.45rem .7rem;font-size:.8rem;">üóë</button>
            </div>`;
        list.appendChild(d);
    });

    list.querySelectorAll('.em-edit').forEach(btn => btn.addEventListener('click', () => {
        const i = +btn.dataset.i, m = metrics[i];
        const rt = m.recordTypes || '';
        openEditModal(`
            <div class="field"><label>–ü–∞—Ä–∞—Ñ—ñ—è / —É—Å—Ç–∞–Ω–æ–≤–∞ *</label><input id="ef_mpar" type="text" value="${esc(m.parish)}"></div>
            <div class="grid-2">
                <div class="field"><label>–†–æ–∫–∏ *</label><input id="ef_myrs" type="text" value="${esc(m.years)}"></div>
                <div class="field"><label>–ö–æ–Ω—Ñ–µ—Å—ñ—è</label><select id="ef_mconf">
                    <option ${m.confession==='–ü—Ä–∞–≤–æ—Å–ª–∞–≤–Ω–∞'?'selected':''}>–ü—Ä–∞–≤–æ—Å–ª–∞–≤–Ω–∞</option>
                    <option ${m.confession==='–†–∏–º–æ-–∫–∞—Ç–æ–ª–∏—Ü—å–∫–∞'?'selected':''}>–†–∏–º–æ-–∫–∞—Ç–æ–ª–∏—Ü—å–∫–∞</option>
                    <option ${m.confession==='–ì—Ä–µ–∫–æ-–∫–∞—Ç–æ–ª–∏—Ü—å–∫–∞'?'selected':''}>–ì—Ä–µ–∫–æ-–∫–∞—Ç–æ–ª–∏—Ü—å–∫–∞</option>
                    <option ${m.confession==='–Ü—É–¥–∞—ó–∑–º'?'selected':''}>–Ü—É–¥–∞—ó–∑–º</option>
                    <option ${m.confession==='–ü—Ä–æ—Ç–µ—Å—Ç–∞–Ω—Ç—Å—å–∫–∞'?'selected':''}>–ü—Ä–æ—Ç–µ—Å—Ç–∞–Ω—Ç—Å—å–∫–∞</option>
                    <option ${m.confession==='–í—Å—ñ –∫–æ–Ω—Ñ–µ—Å—ñ—ó'?'selected':''}>–í—Å—ñ –∫–æ–Ω—Ñ–µ—Å—ñ—ó</option>
                </select></div>
            </div>
            <div class="field"><label>–¢–∏–ø –∑–∞–ø–∏—Å—ñ–≤</label>
                <div style="display:flex;gap:1rem;flex-wrap:wrap;margin-top:.35rem;">
                    <label style="display:flex;align-items:center;gap:.4rem;font-weight:400;cursor:pointer;"><input type="checkbox" id="ef_mb" ${rt.includes('–ù–∞—Ä–æ–¥–∂–µ–Ω–Ω—è')?'checked':''}> üë∂ –ù–∞—Ä–æ–¥–∂–µ–Ω–Ω—è</label>
                    <label style="display:flex;align-items:center;gap:.4rem;font-weight:400;cursor:pointer;"><input type="checkbox" id="ef_mm" ${rt.includes('–®–ª—é–±–∏')?'checked':''}> üíç –®–ª—é–±–∏</label>
                    <label style="display:flex;align-items:center;gap:.4rem;font-weight:400;cursor:pointer;"><input type="checkbox" id="ef_md" ${rt.includes('–°–º–µ—Ä—Ç—ñ')?'checked':''}> üïäÔ∏è –°–º–µ—Ä—Ç—ñ</label>
                    <label style="display:flex;align-items:center;gap:.4rem;font-weight:400;cursor:pointer;"><input type="checkbox" id="ef_mcr" ${rt.includes('–°–ø–æ–≤—ñ–¥–Ω—ñ –∑–∞–ø–∏—Å–∏')?'checked':''}> üìú –°–ø–æ–≤—ñ–¥–Ω—ñ –∑–∞–ø–∏—Å–∏</label>
                </div>
            </div>
            <div class="field"><label>–ù–∞—Å–µ–ª–µ–Ω—ñ –ø—É–Ω–∫—Ç–∏</label><input id="ef_mvil" type="text" value="${esc(m.villages||'')}"></div>
            <div class="field"><label>–ê—Ä—Ö—ñ–≤ —Ç–∞ —Ñ–æ–Ω–¥</label><input id="ef_marc" type="text" value="${esc(m.archive||'')}"></div>
            <div class="field">
                <label>–ü–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ —Å–∫–∞–Ω (Google Drive)</label>
                <input id="ef_mscan" type="url" value="${esc(m.scanUrl||'')}" placeholder="https://drive.google.com/file/d/...">
            </div>
        `, async () => {
            const parish = document.getElementById('ef_mpar').value.trim();
            const years  = document.getElementById('ef_myrs').value.trim();
            if (!parish || !years) throw new Error('–ü–∞—Ä–∞—Ñ—ñ—è —Ç–∞ —Ä–æ–∫–∏ –æ–±–æ–≤\'—è–∑–∫–æ–≤—ñ');
            const types = [];
            if (document.getElementById('ef_mb').checked) types.push('–ù–∞—Ä–æ–¥–∂–µ–Ω–Ω—è');
            if (document.getElementById('ef_mm').checked) types.push('–®–ª—é–±–∏');
            if (document.getElementById('ef_md').checked) types.push('–°–º–µ—Ä—Ç—ñ');
            if (document.getElementById('ef_mcr') && document.getElementById('ef_mcr').checked) types.push('–°–ø–æ–≤—ñ–¥–Ω—ñ –∑–∞–ø–∏—Å–∏');
            const { items, sha } = await loadJsonFromGH(METRICS_FILE);
            const upd = { parish, years, confession: document.getElementById('ef_mconf').value, recordTypes: types.length ? types.join(', ') : '–ù–∞—Ä–æ–¥–∂–µ–Ω–Ω—è, —à–ª—é–±–∏, —Å–º–µ—Ä—Ç—ñ', villages: document.getElementById('ef_mvil').value.trim(), archive: document.getElementById('ef_marc').value.trim() };
            const scan = document.getElementById('ef_mscan').value.trim();
            if (scan) upd.scanUrl = scan;
            items[i] = upd;
            await ghPut(METRICS_FILE, JSON.stringify(items, null, 4), sha, `–†–µ–¥–∞–≥–æ–≤–∞–Ω–æ –º–µ—Ç—Ä–∏—á–Ω—É –∫–Ω–∏–≥—É: ${parish}`);
        });
    }));

    list.querySelectorAll('.em-del').forEach(btn => btn.addEventListener('click', async () => {
        const i = +btn.dataset.i;
        if (!confirm(`–í–∏–¥–∞–ª–∏—Ç–∏ "${metrics[i].parish}"?`)) return;
        btn.disabled=true; btn.textContent='...';
        try {
            const { items, sha } = await loadJsonFromGH(METRICS_FILE);
            await ghPut(METRICS_FILE, JSON.stringify(items.filter((_,j)=>j!==i), null, 4), sha, `–í–∏–¥–∞–ª–µ–Ω–æ: ${metrics[i].parish}`);
            renderList();
        } catch(e) { alert('‚ùå '+e.message); btn.disabled=false; btn.textContent='üóë'; }
    }));
}

async function renderPinList(wrap) {
    const { items: pins, sha } = await loadJsonFromGH('kostel_pins.json');
    if (!pins.length) {
        wrap.innerHTML = '<div class="notice notice-info">üìç –ü—ñ–Ω–∏ —â–µ –Ω–µ –¥–æ–¥–∞–Ω–æ. –°–∫–æ—Ä–∏—Å—Ç–∞–π—Ç–µ—Å—å —Ñ–æ—Ä–º–æ—é –≤–∏—â–µ.</div>';
        return;
    }
    wrap.innerHTML = `
        <h3 style="font-family:'Cormorant Garamond',serif;font-size:1.2rem;margin-bottom:1rem;color:var(--color-text);">
            –ü—ñ–Ω–∏ –∫–æ—Å—Ç–µ–ª—É (${pins.length})
        </h3>
        <div class="photo-list">
        ${pins.map((p, i) => `
            <div class="photo-item">
                <div style="width:72px;height:52px;background:var(--color-bg-secondary);border-radius:0.5rem;display:flex;align-items:center;justify-content:center;font-size:1.4rem;flex-shrink:0;">üìç</div>
                <div class="photo-item-info">
                    <h4>${esc(p.cardTitle)}</h4>
                    <p>X: ${p.x}, Y: ${p.y} ¬∑ –°—Ç–æ—Ä–æ–Ω–∞: ${p.side} ¬∑ ${esc(p.label || '‚Äî')}</p>
                </div>
                <button class="btn btn-red" style="padding:0.4rem 0.75rem;font-size:0.8rem;" data-delpin="${i}">üóë</button>
            </div>
        `).join('')}
        </div>`;
    wrap.querySelectorAll('[data-delpin]').forEach(btn => {
        btn.addEventListener('click', async function() {
            const i = parseInt(this.dataset.delpin);
            if (!confirm(`–í–∏–¥–∞–ª–∏—Ç–∏ –ø—ñ–Ω ¬´${pins[i].cardTitle}¬ª?`)) return;
            this.disabled = true; this.textContent = '...';
            try {
                const { items, sha: s2 } = await loadJsonFromGH('kostel_pins.json');
                await ghPut('kostel_pins.json', JSON.stringify(items.filter((_,j)=>j!==i), null, 2), s2, `–í–∏–¥–∞–ª–µ–Ω–æ –ø—ñ–Ω: ${pins[i].cardTitle}`);
                renderList();
            } catch(e) { alert('‚ùå '+e.message); this.disabled=false; this.textContent='üóë'; }
        });
    });
}

}); // end DOMContentLoaded
</script>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// KOSTEL PIN EDITOR ‚Äî Architecture page pin manager
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
(function(){

var KOSTEL_FILE = 'kostel_pins.json';
var KOSTEL_REPO = 'jerkinsmichael13-stack/Dubrovytsia1';
var KOSTEL_IMG_SRC = 'https://i.imgur.com/Ru7uTkK.jpeg';

var kostelPins = [];
var pendingKX = 0, pendingKY = 0;
var dragKPin = null, dragKOffset = {x:0, y:0};
var hasKDragged = false;
var editingKPin = null;

var kwrap  = document.getElementById('kostelEditorWrap');
var kimg   = document.getElementById('kostelEditorImg');
var ksvg   = document.getElementById('kostelEditorSVG');
var kplist = document.getElementById('kostelPinListWrap');
var kpempty= document.getElementById('kostelPinListEmpty');
var kmodal = document.getElementById('kostelPinModal');
var kst    = document.getElementById('kostelEditorStatus');

// ‚îÄ‚îÄ Init (called when admin logs in) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function kostelInit() {
    loadKostelPins();

    var mdX=0, mdY=0;
    kwrap.addEventListener('mousedown', function(e){ mdX=e.clientX; mdY=e.clientY; hasKDragged=false; });
    ksvg.addEventListener('mousedown', function(e){ mdX=e.clientX; mdY=e.clientY; });
    document.addEventListener('mousemove', function(e){
        if(Math.abs(e.clientX-mdX)>4 || Math.abs(e.clientY-mdY)>4) hasKDragged=true;
    });

    kwrap.addEventListener('click', function(e){
        if(hasKDragged){ hasKDragged=false; return; }
        if(e.target.closest('[data-kpin]')) return;
        var r = kimg.getBoundingClientRect();
        if(!r.width) return;
        pendingKX = Math.round(((e.clientX-r.left)/r.width)*1000)/10;
        pendingKY = Math.round(((e.clientY-r.top)/r.height)*1000)/10;
        pendingKX = Math.max(0,Math.min(100,pendingKX));
        pendingKY = Math.max(0,Math.min(100,pendingKY));
        editingKPin = null;
        openKModal();
    });

    // Drag
    ksvg.addEventListener('mousedown', function(e){
        var g = e.target.closest('[data-kpin]');
        if(!g) return;
        e.preventDefault();
        dragKPin = g;
        var pin = kostelPins.find(function(p){ return String(p.id)===g.dataset.kpin; });
        if(!pin) return;
        var r = kimg.getBoundingClientRect();
        dragKOffset.x = e.clientX - r.left - pin.x/100*r.width;
        dragKOffset.y = e.clientY - r.top  - pin.y/100*r.height;
    });
    document.addEventListener('mousemove', function(e){
        if(!dragKPin) return;
        hasKDragged = true;
        var r = kimg.getBoundingClientRect();
        if(!r.width) return;
        var px = Math.round(Math.max(0,Math.min(100,(e.clientX-r.left-dragKOffset.x)/r.width*100))*10)/10;
        var py = Math.round(Math.max(0,Math.min(100,(e.clientY-r.top-dragKOffset.y)/r.height*100))*10)/10;
        var pin = kostelPins.find(function(p){ return String(p.id)===dragKPin.dataset.kpin; });
        if(!pin) return;
        pin.x = px; pin.y = py;
        renderKSVG();
    });
    document.addEventListener('mouseup', function(){ if(dragKPin){ dragKPin=null; } });

    document.getElementById('kostelPinSaveBtn').addEventListener('click', saveKModal);
    document.getElementById('kostelPinCancelBtn').addEventListener('click', closeKModal);
    kmodal.addEventListener('click', function(e){ if(e.target===kmodal) closeKModal(); });
    document.addEventListener('keydown', function(e){ if(e.key==='Escape') closeKModal(); });

    document.getElementById('kostelSaveBtn').addEventListener('click', saveKostelToGH);
    document.getElementById('kostelClearBtn').addEventListener('click', function(){
        if(!confirm('–í–∏–¥–∞–ª–∏—Ç–∏ –≤—Å—ñ –ø—ñ–Ω–∏ –∫–æ—Å—Ç–µ–ª—É?')) return;
        kostelPins = []; renderKEditor();
    });
    document.getElementById('kostelCopyJsonBtn').addEventListener('click', function(){
        var j = JSON.stringify(kostelPins, null, 2);
        navigator.clipboard.writeText(j).then(function(){ showKSt('üìã JSON —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ!','success'); })
        .catch(function(){ showKSt(j,'info'); });
    });
}

// ‚îÄ‚îÄ Modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openKModal(pin) {
    document.getElementById('kostelPinModalTitle').textContent = pin ? '–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –ø—ñ–Ω' : '–ù–æ–≤–∏–π –ø—ñ–Ω';
    document.getElementById('kostelSideL').checked = !pin || pin.side !== 'R';
    document.getElementById('kostelSideR').checked = pin && pin.side === 'R';
    document.getElementById('kostelPinLabel').value      = pin ? (pin.label || '') : '';
    document.getElementById('kostelPinCardTitle').value  = pin ? (pin.cardTitle || '') : '';
    document.getElementById('kostelPinText1').value      = pin ? (pin.text1 || '') : '';
    document.getElementById('kostelPinText2').value      = pin ? (pin.text2 || '') : '';
    kmodal.style.display = 'flex';
    setTimeout(function(){ document.getElementById('kostelPinLabel').focus(); }, 50);
}
function closeKModal() {
    kmodal.style.display = 'none';
    editingKPin = null;
}
function saveKModal() {
    var label = document.getElementById('kostelPinLabel').value.trim();
    var cardTitle = document.getElementById('kostelPinCardTitle').value.trim();
    if(!label || !cardTitle){ alert('–ú—ñ—Ç–∫–∞ —Ç–∞ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –æ–±–æ–≤\'—è–∑–∫–æ–≤—ñ'); return; }
    var side = document.querySelector('input[name="kostelPinSide"]:checked').value;
    var text1 = document.getElementById('kostelPinText1').value.trim();
    var text2 = document.getElementById('kostelPinText2').value.trim();

    if(editingKPin) {
        editingKPin.side = side;
        editingKPin.label = label;
        editingKPin.cardTitle = cardTitle;
        editingKPin.text1 = text1;
        editingKPin.text2 = text2;
    } else {
        var maxId = kostelPins.length ? Math.max.apply(null, kostelPins.map(function(p){return p.id;})) : 0;
        kostelPins.push({ id: maxId+1, x: pendingKX, y: pendingKY, side: side, label: label, cardTitle: cardTitle, text1: text1, text2: text2 });
    }
    closeKModal();
    renderKEditor();
}

// ‚îÄ‚îÄ Render ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderKEditor() { renderKSVG(); renderKList(); }

function renderKSVG() {
    var ns = 'http://www.w3.org/2000/svg';
    while(ksvg.firstChild) ksvg.removeChild(ksvg.firstChild);
    var wr = kwrap.getBoundingClientRect();
    var ir = kimg.getBoundingClientRect();
    var ox = ir.left - wr.left;
    var oy = ir.top  - wr.top;

    kostelPins.forEach(function(pin){
        var px = pin.x/100 * ir.width  + ox;
        var py = pin.y/100 * ir.height + oy;

        var g = document.createElementNS(ns,'g');
        g.setAttribute('data-kpin', String(pin.id));
        g.style.cursor = 'move';
        g.style.pointerEvents = 'all';

        var ring = document.createElementNS(ns,'circle');
        ring.setAttribute('cx',px); ring.setAttribute('cy',py);
        ring.setAttribute('r','16'); ring.setAttribute('fill','none');
        ring.setAttribute('stroke','rgba(201,162,39,0.45)'); ring.setAttribute('stroke-width','1.5');

        var dot = document.createElementNS(ns,'circle');
        dot.setAttribute('cx',px); dot.setAttribute('cy',py);
        dot.setAttribute('r','10'); dot.setAttribute('fill','#c9a227');
        dot.setAttribute('stroke','#fff'); dot.setAttribute('stroke-width','2');
        dot.setAttribute('filter','drop-shadow(0 2px 6px rgba(0,0,0,.7))');

        var txt = document.createElementNS(ns,'text');
        txt.setAttribute('x',px); txt.setAttribute('y',py);
        txt.setAttribute('text-anchor','middle');
        txt.setAttribute('dominant-baseline','central');
        txt.setAttribute('fill','#1a1000');
        txt.setAttribute('font-size','10'); txt.setAttribute('font-weight','800');
        txt.setAttribute('font-family','DM Sans,sans-serif');
        txt.setAttribute('pointer-events','none');
        txt.textContent = String(pin.id);

        // Side label
        var lbl = document.createElementNS(ns,'text');
        lbl.setAttribute('x', pin.side==='L' ? px-20 : px+20);
        lbl.setAttribute('y', py);
        lbl.setAttribute('text-anchor', pin.side==='L' ? 'end' : 'start');
        lbl.setAttribute('dominant-baseline','central');
        lbl.setAttribute('fill','rgba(201,162,39,0.75)');
        lbl.setAttribute('font-size','8');
        lbl.setAttribute('font-family','DM Sans,sans-serif');
        lbl.setAttribute('pointer-events','none');
        lbl.textContent = pin.side==='L' ? '‚óÄ L' : 'R ‚ñ∂';

        g.appendChild(ring); g.appendChild(dot); g.appendChild(txt); g.appendChild(lbl);
        ksvg.appendChild(g);
    });
}

function renderKList() {
    kpempty.style.display = kostelPins.length ? 'none' : 'block';
    kplist.innerHTML = '';
    kostelPins.forEach(function(pin){
        var row = document.createElement('div');
        row.style.cssText = 'display:flex;align-items:flex-start;gap:0.6rem;padding:0.75rem;background:var(--color-bg);border:1px solid var(--color-border);border-radius:8px;';

        row.innerHTML =
            '<div style="min-width:26px;height:26px;border-radius:50%;background:#c9a227;color:#1a1000;font-size:0.65rem;font-weight:800;display:flex;align-items:center;justify-content:center;flex-shrink:0;">'+pin.id+'</div>'+
            '<div style="flex:1;min-width:0;">'+
                '<div style="font-size:0.85rem;font-weight:700;color:var(--color-text);">'+escHtmlK(pin.cardTitle)+'</div>'+
                '<div style="font-size:0.7rem;color:var(--color-text-secondary);margin-top:0.15rem;">'+
                    '<span style="color:#c9a227;font-weight:600;">'+(pin.side==='L'?'‚óÄ –õ—ñ–≤–æ':'–ü—Ä–∞–≤–æ ‚ñ∂')+'</span>'+
                    ' ¬∑ '+escHtmlK(pin.label)+
                '</div>'+
                '<div style="font-size:0.7rem;color:var(--color-text-secondary);font-family:monospace;margin-top:0.1rem;">x:'+pin.x+'% y:'+pin.y+'%</div>'+
            '</div>'+
            '<div style="display:flex;gap:0.3rem;flex-shrink:0;">'+
                '<button class="kp-edit" data-id="'+pin.id+'" style="padding:.3rem .6rem;border:1px solid var(--color-border);border-radius:6px;background:transparent;color:var(--color-text-secondary);font-size:0.7rem;cursor:pointer;">‚úèÔ∏è</button>'+
                '<button class="kp-del" data-id="'+pin.id+'" style="padding:.3rem .6rem;border:1px solid #e0b0b0;border-radius:6px;background:transparent;color:#c0392b;font-size:0.7rem;cursor:pointer;">üóëÔ∏è</button>'+
            '</div>';

        kplist.appendChild(row);
    });

    kplist.querySelectorAll('.kp-edit').forEach(function(btn){
        btn.addEventListener('click', function(){
            var pin = kostelPins.find(function(p){ return String(p.id)===btn.dataset.id; });
            if(!pin) return;
            editingKPin = pin;
            openKModal(pin);
        });
    });
    kplist.querySelectorAll('.kp-del').forEach(function(btn){
        btn.addEventListener('click', function(){
            var pin = kostelPins.find(function(p){ return String(p.id)===btn.dataset.id; });
            if(!pin || !confirm('–í–∏–¥–∞–ª–∏—Ç–∏ –ø—ñ–Ω "'+pin.cardTitle+'"?')) return;
            kostelPins = kostelPins.filter(function(p){ return String(p.id)!==btn.dataset.id; });
            renderKEditor();
        });
    });
}

// ‚îÄ‚îÄ GitHub save/load ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function saveKostelToGH() {
    var tok = localStorage.getItem('gh_token_dubrovytsia') || '';
    if(!tok){ showKSt('‚ö†Ô∏è –°–ø–æ—á–∞—Ç–∫—É –≤–≤–µ–¥—ñ—Ç—å GitHub —Ç–æ–∫–µ–Ω –≤–∏—â–µ','warn'); return; }
    var json = JSON.stringify(kostelPins, null, 2);
    showKSt('‚è≥ –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è...','info');
    try {
        var sha = null;
        var resp = await fetch('https://api.github.com/repos/'+KOSTEL_REPO+'/contents/'+KOSTEL_FILE, {
            headers:{ Authorization:'token '+tok, Accept:'application/vnd.github.v3+json' }
        });
        if(resp.ok){ var d = await resp.json(); sha = d.sha; }
        var body = { message:'Update kostel_pins.json via admin', content: btoa(unescape(encodeURIComponent(json))), branch:'main' };
        if(sha) body.sha = sha;
        var put = await fetch('https://api.github.com/repos/'+KOSTEL_REPO+'/contents/'+KOSTEL_FILE, {
            method:'PUT', headers:{ Authorization:'token '+tok, Accept:'application/vnd.github.v3+json', 'Content-Type':'application/json' },
            body: JSON.stringify(body)
        });
        if(put.ok) showKSt('‚úÖ –ü—ñ–Ω–∏ –∫–æ—Å—Ç–µ–ª—É –∑–±–µ—Ä–µ–∂–µ–Ω–æ –Ω–∞ GitHub! –°—Ç–æ—Ä—ñ–Ω–∫–∞ –æ–Ω–æ–≤–∏—Ç—å—Å—è –∑–∞ ~1 —Ö–≤.','success');
        else { var e=await put.json(); showKSt('‚ùå '+(e.message||'–ü–æ–º–∏–ª–∫–∞'),'error'); }
    } catch(err){ showKSt('‚ùå '+err.message,'error'); }
}

function loadKostelPins() {
    fetch('https://raw.githubusercontent.com/'+KOSTEL_REPO+'/main/'+KOSTEL_FILE+'?v='+Date.now())
        .then(function(r){ return r.ok ? r.json() : []; })
        .then(function(data){ if(Array.isArray(data)){ kostelPins = data; renderKEditor(); } })
        .catch(function(){});
}

function showKSt(msg, type) {
    kst.className='notice notice-'+(type||'info');
    kst.innerHTML=msg; kst.style.display='block';
}
function escHtmlK(s) {
    return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

// Boot: watch for admin login
document.addEventListener('DOMContentLoaded', function(){
    var obs = new MutationObserver(function(muts){
        muts.forEach(function(m){
            if(m.target.id==='adminContent' && m.target.style.display!=='none'){
                if(kimg.complete) kostelInit();
                else kimg.addEventListener('load', kostelInit, {once:true});
                obs.disconnect();
            }
        });
    });
    obs.observe(document.getElementById('adminContent'), {attributes:true, attributeFilter:['style']});
    window.addEventListener('resize', function(){ if(kostelPins.length) renderKSVG(); });
});

})();
</script>
    <script src="script_premium.js"></script>
</body>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MAP EDITOR ‚Äî Aerial Pin Manager
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
(function(){

var MAPS_CONFIG = {
    '1944': {
        img:    'https://i.imgur.com/dyP4WgZ.jpeg',
        file:   'aerial_pins_1944.json'
    },
    '1943': {
        img:    'https://i.imgur.com/EhsjkKX.jpeg',
        file:   'aerial_pins_1943.json'
    }
};

var currentMapId = '1944';
var pins = { '1944': [], '1943': [] };
var pendingX = 0, pendingY = 0;  // in percentages 0-100
var dragPin = null, dragOffset = {x:0, y:0};
var hasDragged = false;

var editorWrap = document.getElementById('mapEditorWrap');
var editorImg  = document.getElementById('editorImg');
var editorSVG  = document.getElementById('editorSVG');
var pinListWrap= document.getElementById('pinListWrap');
var pinListEmpty=document.getElementById('pinListEmpty');
var pinModal   = document.getElementById('pinModal');
var modalTitle = document.getElementById('pinModalTitle');
var modalDesc  = document.getElementById('pinModalDesc');
var edStatus   = document.getElementById('mapEditorStatus');

// ‚îÄ‚îÄ Initialize ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function init() {
    // Map selector buttons
    document.querySelectorAll('.map-sel-btn').forEach(function(btn){
        btn.addEventListener('click', function(){
            document.querySelectorAll('.map-sel-btn').forEach(function(b){
                b.style.background = 'transparent';
                b.style.color = 'var(--color-text)';
                b.style.borderColor = 'var(--color-border)';
            });
            btn.style.background = 'var(--color-primary)';
            btn.style.color = '#fff';
            btn.style.borderColor = 'var(--color-primary)';
            switchMap(btn.dataset.mapid);
        });
    });

    // Click on editor to add pin ‚Äî track mousedown pos to distinguish drag from click
    var mouseDownX = 0, mouseDownY = 0;

    editorWrap.addEventListener('mousedown', function(e){
        mouseDownX = e.clientX; mouseDownY = e.clientY;
        hasDragged = false;
    });
    // Also catch mousedown on SVG transparent area (it has pointer-events:all)
    editorSVG.addEventListener('mousedown', function(e){
        mouseDownX = e.clientX; mouseDownY = e.clientY;
        if (!e.target.closest('[data-pin-id]')) {
            hasDragged = false;
        }
    });

    document.addEventListener('mousemove', function(e){
        if (Math.abs(e.clientX - mouseDownX) > 4 || Math.abs(e.clientY - mouseDownY) > 4) {
            hasDragged = true;
        }
    });

    editorWrap.addEventListener('click', function(e){
        if (hasDragged) { hasDragged = false; return; }
        if (e.target.closest('[data-pin-id]')) return;
        var rect = editorImg.getBoundingClientRect();
        if (!rect.width || !rect.height) return;
        pendingX = Math.round(((e.clientX - rect.left) / rect.width)  * 100 * 10) / 10;
        pendingY = Math.round(((e.clientY - rect.top)  / rect.height) * 100 * 10) / 10;
        pendingX = Math.max(0, Math.min(100, pendingX));
        pendingY = Math.max(0, Math.min(100, pendingY));
        openModal();
    });

    // Modal save ‚Äî single listener via onclick property only
    document.getElementById('pinModalSave').onclick = defaultModalSave;

    // Modal cancel
    document.getElementById('pinModalCancel').addEventListener('click', closeModal);
    pinModal.addEventListener('click', function(e){ if(e.target===pinModal) closeModal(); });
    document.addEventListener('keydown', function(e){ if(e.key==='Escape') closeModal(); });

    // Save button
    document.getElementById('saveMapBtn').addEventListener('click', savePins);

    // Clear all
    document.getElementById('clearAllPinsBtn').addEventListener('click', function(){
        if (!confirm('–í–∏–¥–∞–ª–∏—Ç–∏ –≤—Å—ñ –ø—ñ–Ω–∏ –¥–ª—è —Ü—å–æ–≥–æ –∑–Ω—ñ–º–∫—É?')) return;
        pins[currentMapId] = [];
        renderEditor();
    });

    // Copy JSON
    document.getElementById('copyJsonBtn').addEventListener('click', function(){
        var json = JSON.stringify(pins[currentMapId], null, 2);
        navigator.clipboard.writeText(json).then(function(){
            showEdStatus('üìã JSON —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ!', 'success');
        }).catch(function(){
            showEdStatus(json, 'info');
        });
    });

    // SVG drag ‚Äî pins are stored as % but SVG uses pixel positions within wrap
    editorSVG.addEventListener('mousedown', function(e){
        var g = e.target.closest('[data-pin-id]');
        if (!g) return;
        e.preventDefault();
        dragPin = g;
        var pin = pins[currentMapId].find(function(p){ return String(p.id)===g.dataset.pinId; });
        if (!pin) return;
        var rect = editorImg.getBoundingClientRect();
        var pxX = pin.x / 100 * rect.width;
        var pxY = pin.y / 100 * rect.height;
        dragOffset.x = e.clientX - rect.left - pxX;
        dragOffset.y = e.clientY - rect.top  - pxY;
    });

    document.addEventListener('mousemove', function(e){
        if (!dragPin) return;
        hasDragged = true;
        var rect = editorImg.getBoundingClientRect();
        if (!rect.width || !rect.height) return;
        var pxX = e.clientX - rect.left - dragOffset.x;
        var pxY = e.clientY - rect.top  - dragOffset.y;
        var x = Math.round(Math.max(0, Math.min(100, pxX / rect.width  * 100)) * 10) / 10;
        var y = Math.round(Math.max(0, Math.min(100, pxY / rect.height * 100)) * 10) / 10;
        var pin = pins[currentMapId].find(function(p){ return String(p.id)===dragPin.dataset.pinId; });
        if (!pin) return;
        pin.x = x; pin.y = y;
        // update SVG circles position in wrap-relative coords
        var wRect = editorWrap.getBoundingClientRect();
        var wpxX = x / 100 * rect.width  + (rect.left - wRect.left);
        var wpxY = y / 100 * rect.height + (rect.top  - wRect.top);
        dragPin.querySelectorAll('circle').forEach(function(c){
            c.setAttribute('cx', wpxX); c.setAttribute('cy', wpxY);
        });
        var t = dragPin.querySelector('text');
        if (t){ t.setAttribute('x', wpxX); t.setAttribute('y', wpxY); }
        var coordEl = document.getElementById('coord-'+dragPin.dataset.pinId);
        if (coordEl) coordEl.textContent = 'x:'+x+'% y:'+y+'%';
    });

    document.addEventListener('mouseup', function(){
        if (dragPin){ dragPin=null; renderEditor(); }
    });

    // Load existing pins on init
    loadAllPins();
}

// ‚îÄ‚îÄ Switch map ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function switchMap(id) {
    currentMapId = id;
    var cfg = MAPS_CONFIG[id];
    editorImg.src = cfg.img;
    renderEditor();
}

// ‚îÄ‚îÄ Render SVG + pin list ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderEditor() {
    renderSVG();
    renderPinList();
}

function renderSVG() {
    var ns   = 'http://www.w3.org/2000/svg';
    var list = pins[currentMapId] || [];
    while (editorSVG.firstChild) editorSVG.removeChild(editorSVG.firstChild);

    // We need to position pins in wrap-relative pixels from % values
    // Use the image's rendered rect relative to the wrap
    var wRect = editorWrap.getBoundingClientRect();
    var iRect = editorImg.getBoundingClientRect();
    var offX = iRect.left - wRect.left;
    var offY = iRect.top  - wRect.top;

    list.forEach(function(pin){
        var px = pin.x / 100 * iRect.width  + offX;
        var py = pin.y / 100 * iRect.height + offY;

        var g = document.createElementNS(ns,'g');
        g.setAttribute('data-pin-id', String(pin.id));
        g.style.cursor = 'move';
        g.style.pointerEvents = 'all';

        var ring = document.createElementNS(ns,'circle');
        ring.setAttribute('cx', px); ring.setAttribute('cy', py);
        ring.setAttribute('r','14');
        ring.setAttribute('fill','none');
        ring.setAttribute('stroke','rgba(201,162,39,0.5)');
        ring.setAttribute('stroke-width','1.5');

        var circ = document.createElementNS(ns,'circle');
        circ.setAttribute('cx', px); circ.setAttribute('cy', py);
        circ.setAttribute('r','10');
        circ.setAttribute('fill','#c9a227');
        circ.setAttribute('stroke','#fff'); circ.setAttribute('stroke-width','2');
        circ.setAttribute('filter','drop-shadow(0 2px 5px rgba(0,0,0,.6))');

        var txt = document.createElementNS(ns,'text');
        txt.setAttribute('x', px); txt.setAttribute('y', py);
        txt.setAttribute('text-anchor','middle');
        txt.setAttribute('dominant-baseline','central');
        txt.setAttribute('fill','#1a1000');
        txt.setAttribute('font-size','10');
        txt.setAttribute('font-weight','800');
        txt.setAttribute('font-family','DM Sans,sans-serif');
        txt.setAttribute('pointer-events','none');
        txt.textContent = String(pin.id);

        g.appendChild(ring); g.appendChild(circ); g.appendChild(txt);
        editorSVG.appendChild(g);
    });
}

function renderPinList() {
    var list = pins[currentMapId] || [];
    pinListEmpty.style.display = list.length ? 'none' : 'block';
    pinListWrap.innerHTML = '';
    list.forEach(function(pin){
        var row = document.createElement('div');
        row.style.cssText = 'display:flex;align-items:center;gap:0.6rem;padding:0.55rem 0.75rem;'+
            'background:var(--color-bg);border:1px solid var(--color-border);border-radius:8px;';

        var num = document.createElement('span');
        num.style.cssText = 'min-width:22px;height:22px;border-radius:50%;background:#c9a227;'+
            'color:#1a1000;font-size:0.6rem;font-weight:800;display:flex;align-items:center;'+
            'justify-content:center;flex-shrink:0;';
        num.textContent = pin.id;

        var info = document.createElement('div');
        info.style.cssText = 'flex:1;min-width:0;';
        info.innerHTML = '<div style="font-size:0.8rem;font-weight:600;color:var(--color-text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">'+escHtml(pin.title)+'</div>'+
            '<div id="coord-'+pin.id+'" style="font-size:0.65rem;color:var(--color-text-secondary);font-family:monospace;">x:'+pin.x+'% y:'+pin.y+'%</div>';

        var editBtn = document.createElement('button');
        editBtn.style.cssText = 'padding:0.3rem 0.6rem;border:1px solid var(--color-border);border-radius:6px;'+
            'background:transparent;color:var(--color-text-secondary);font-size:0.7rem;cursor:pointer;flex-shrink:0;';
        editBtn.textContent = '‚úèÔ∏è';
        editBtn.title = '–†–µ–¥–∞–≥—É–≤–∞—Ç–∏';
        editBtn.addEventListener('click', (function(p){ return function(){ editPin(p); }; })(pin));

        var delBtn = document.createElement('button');
        delBtn.style.cssText = 'padding:0.3rem 0.6rem;border:1px solid #e0b0b0;border-radius:6px;'+
            'background:transparent;color:#c0392b;font-size:0.7rem;cursor:pointer;flex-shrink:0;';
        delBtn.textContent = 'üóëÔ∏è';
        delBtn.title = '–í–∏–¥–∞–ª–∏—Ç–∏';
        delBtn.addEventListener('click', (function(id){ return function(){
            pins[currentMapId] = pins[currentMapId].filter(function(p){ return p.id!==id; });
            renderEditor();
        }; })(pin.id));

        row.appendChild(num); row.appendChild(info); row.appendChild(editBtn); row.appendChild(delBtn);
        pinListWrap.appendChild(row);
    });
}

function escHtml(s) {
    return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

// ‚îÄ‚îÄ Modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openModal() {
    modalTitle.value = ''; modalDesc.value = '';
    document.getElementById('pinModalSave').onclick = defaultModalSave;
    pinModal.style.display = 'flex';
    setTimeout(function(){ modalTitle.focus(); }, 50);
}
function closeModal() { pinModal.style.display = 'none'; }

function editPin(pin) {
    pendingX = pin.x; pendingY = pin.y;
    modalTitle.value = pin.title;
    modalDesc.value  = pin.desc || '';
    document.getElementById('pinModalSave').onclick = function(){
        var title = modalTitle.value.trim();
        if (!title){ modalTitle.focus(); return; }
        pin.title = title; pin.desc = modalDesc.value.trim();
        closeModal(); renderEditor();
        document.getElementById('pinModalSave').onclick = defaultModalSave;
    };
    pinModal.style.display = 'flex';
    setTimeout(function(){ modalTitle.focus(); }, 50);
}

function defaultModalSave() {
    var title = modalTitle.value.trim();
    if (!title){ modalTitle.focus(); return; }
    var list = pins[currentMapId];
    var id   = list.length ? Math.max.apply(null, list.map(function(p){return p.id;})) + 1 : 1;
    // Store in unified % format
    list.push({ id:id, x:pendingX, y:pendingY, title:title, desc:modalDesc.value.trim() });
    closeModal(); renderEditor();
}

// ‚îÄ‚îÄ GitHub save ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function savePins() {
    var tok = localStorage.getItem('gh_token_dubrovytsia') || '';
    if (!tok){ showEdStatus('‚ö†Ô∏è –°–ø–æ—á–∞—Ç–∫—É –≤–≤–µ–¥—ñ—Ç—å GitHub —Ç–æ–∫–µ–Ω —É —Ä–æ–∑–¥—ñ–ª—ñ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å –≤–∏—â–µ', 'warn'); return; }
    var file = MAPS_CONFIG[currentMapId].file;
    var json = JSON.stringify(pins[currentMapId], null, 2);
    showEdStatus('‚è≥ –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è...', 'info');
    try {
        var sha = null;
        var resp = await fetch('https://api.github.com/repos/jerkinsmichael13-stack/Dubrovytsia1/contents/'+file,{
            headers:{ Authorization:'token '+tok, Accept:'application/vnd.github.v3+json' }
        });
        if (resp.ok){ var d = await resp.json(); sha = d.sha; }
        var body = { message:'Update '+file+' via admin', content:btoa(unescape(encodeURIComponent(json))), branch:'main' };
        if (sha) body.sha = sha;
        var put = await fetch('https://api.github.com/repos/jerkinsmichael13-stack/Dubrovytsia1/contents/'+file,{
            method:'PUT', headers:{ Authorization:'token '+tok, Accept:'application/vnd.github.v3+json', 'Content-Type':'application/json' },
            body: JSON.stringify(body)
        });
        if (put.ok) showEdStatus('‚úÖ –ü—ñ–Ω–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–æ –Ω–∞ GitHub! –°–∞–π—Ç –æ–Ω–æ–≤–∏—Ç—å—Å—è –∑–∞ ~1 —Ö–≤.', 'success');
        else { var e=await put.json(); showEdStatus('‚ùå '+( e.message||'–ü–æ–º–∏–ª–∫–∞'), 'error'); }
    } catch(err){ showEdStatus('‚ùå '+err.message, 'error'); }
}

// ‚îÄ‚îÄ Load pins from GitHub ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function normalizePin(p) {
    var x = p.x !== undefined ? p.x : (p.pct ? p.pct.x : 50);
    var y = p.y !== undefined ? p.y : (p.pct ? p.pct.y : 50);
    return { id: p.id||p.n||1, x: parseFloat(x)||0, y: parseFloat(y)||0, title: p.title||p.t||'', desc: p.desc||p.d||'' };
}

function loadAllPins() {
    ['1944','1943'].forEach(function(key){
        var file = MAPS_CONFIG[key].file;
        fetch('https://raw.githubusercontent.com/jerkinsmichael13-stack/Dubrovytsia1/main/'+file+'?v='+Date.now())
            .then(function(r){ return r.ok ? r.json() : []; })
            .then(function(data){
                if (Array.isArray(data) && data.length) {
                    pins[key] = data.map(normalizePin);
                    if (key === currentMapId) renderEditor();
                }
            })
            .catch(function(){});
    });
}

function showEdStatus(msg, type) {
    edStatus.className = 'notice notice-'+(type||'info');
    edStatus.innerHTML = msg;
    edStatus.style.display = 'block';
}

// Start ‚Äî wait for image to load before first render
document.addEventListener('DOMContentLoaded', function(){
    var observer = new MutationObserver(function(muts){
        muts.forEach(function(m){
            if (m.target.id==='adminContent' && m.target.style.display!=='none') {
                // Wait for image to load for correct positioning
                if (editorImg.complete) { init(); }
                else { editorImg.addEventListener('load', init, {once:true}); }
                observer.disconnect();
            }
        });
    });
    observer.observe(document.getElementById('adminContent'), { attributes:true, attributeFilter:['style'] });

    // Also re-render on resize for correct pin placement
    window.addEventListener('resize', function(){
        if (pins[currentMapId]) renderEditor();
    });
});

})();
</script>
</html>